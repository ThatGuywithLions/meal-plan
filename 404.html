<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#4CAF50">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="icon.svg">
<title>Meal Plan</title>
<style>
/* ============================================
   CSS Custom Properties
   ============================================ */
:root {
  --protein: #4CAF50;
  --carbs: #FF9800;
  --fat: #2196F3;
  --calories: #F44336;
  --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  --radius: 12px;
  --radius-sm: 8px;
  --nav-height: 56px;
  --header-height: 52px;
}

[data-theme="dark"] {
  --bg-primary: #0f0f0f;
  --bg-secondary: #1a1a1a;
  --bg-card: #1e1e1e;
  --bg-card-alt: #252525;
  --bg-input: #2a2a2a;
  --bg-nav: #141414;
  --text-primary: #f0f0f0;
  --text-secondary: #a0a0a0;
  --text-muted: #606060;
  --border: #2a2a2a;
  --border-light: #333;
  --shadow: 0 2px 8px rgba(0,0,0,0.3);
  --shadow-lg: 0 4px 16px rgba(0,0,0,0.4);
  --badge-bg: rgba(255,255,255,0.06);
  --accent: #7c4dff;
  --accent-soft: rgba(124,77,255,0.15);
  --done-bg: rgba(76,175,80,0.1);
  --done-border: rgba(76,175,80,0.3);
  --skip-bg: rgba(255,255,255,0.03);
  --skip-text: #666;
  --progress-bg: #2a2a2a;
  --overlay: rgba(0,0,0,0.6);
  --checked-bg: rgba(255,255,255,0.03);
}

/* ============================================
   Reset & Base
   ============================================ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html {
  font-size: 16px;
  -webkit-text-size-adjust: 100%;
  -webkit-tap-highlight-color: transparent;
}

body {
  font-family: var(--font);
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100dvh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

button {
  font-family: inherit;
  font-size: inherit;
  border: none;
  background: none;
  cursor: pointer;
  color: inherit;
  -webkit-tap-highlight-color: transparent;
}

/* ============================================
   App Layout
   ============================================ */
#app {
  display: flex;
  flex-direction: column;
  min-height: 100dvh;
}

#app-header {
  position: sticky;
  top: 0;
  z-index: 100;
  height: var(--header-height);
  background: var(--bg-nav);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  backdrop-filter: blur(12px);
}

#app-header h1 {
  font-size: 1rem;
  font-weight: 600;
  letter-spacing: -0.02em;
}

#header-info {
  font-size: 0.75rem;
  color: var(--text-secondary);
}

#tab-content {
  flex: 1;
  padding: 12px 12px calc(var(--nav-height) + 16px);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

/* ============================================
   Bottom Navigation
   ============================================ */
#bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: var(--nav-height);
  background: var(--bg-nav);
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-around;
  z-index: 100;
  padding-bottom: env(safe-area-inset-bottom, 0);
}

.nav-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  min-width: 56px;
  min-height: 44px;
  padding: 6px 4px;
  border-radius: var(--radius-sm);
  transition: all 0.15s ease;
  position: relative;
}

.nav-btn .nav-icon { font-size: 1.2rem; line-height: 1; }
.nav-btn .nav-label { font-size: 0.65rem; font-weight: 500; color: var(--text-muted); }

.nav-btn.active .nav-label { color: var(--accent); font-weight: 600; }
.nav-btn.active::before {
  content: '';
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 24px;
  height: 2px;
  background: var(--accent);
  border-radius: 1px;
}

/* ============================================
   Shared Components
   ============================================ */
.card {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 14px;
  margin-bottom: 10px;
  box-shadow: var(--shadow);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 8px;
}

.card-title {
  font-size: 0.9rem;
  font-weight: 600;
  line-height: 1.3;
}

.card-subtitle {
  font-size: 0.75rem;
  color: var(--text-secondary);
  margin-top: 2px;
}

.slot-badge {
  font-size: 0.65rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  padding: 3px 8px;
  border-radius: 4px;
  background: var(--badge-bg);
  color: var(--text-secondary);
  white-space: nowrap;
}

/* Macro badges inline */
.macro-row {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin: 8px 0;
}

.macro-badge {
  display: inline-flex;
  align-items: center;
  gap: 3px;
  font-size: 0.7rem;
  font-weight: 600;
  padding: 3px 7px;
  border-radius: 4px;
  background: var(--badge-bg);
}

.macro-badge.cal { color: var(--calories); }
.macro-badge.pro { color: var(--protein); }
.macro-badge.carb { color: var(--carbs); }
.macro-badge.fat { color: var(--fat); }

/* Progress bars */
.progress-bar {
  height: 6px;
  background: var(--progress-bg);
  border-radius: 3px;
  overflow: hidden;
  position: relative;
}

.progress-bar .fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.4s ease;
}

.progress-bar-lg { height: 8px; border-radius: 4px; }
.progress-bar-lg .fill { border-radius: 4px; }

/* Macro progress compound bar */
.macro-progress {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin: 10px 0;
}

.macro-progress-row {
  display: flex;
  align-items: center;
  gap: 8px;
}

.macro-progress-label {
  font-size: 0.7rem;
  font-weight: 600;
  width: 20px;
  text-align: right;
  flex-shrink: 0;
}

.macro-progress-bar {
  flex: 1;
  height: 6px;
  background: var(--progress-bg);
  border-radius: 3px;
  overflow: hidden;
}

.macro-progress-bar .fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.4s ease;
}

.macro-progress-value {
  font-size: 0.7rem;
  color: var(--text-secondary);
  width: 70px;
  text-align: right;
  flex-shrink: 0;
}

/* Action buttons */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  min-height: 44px;
  padding: 10px 16px;
  border-radius: var(--radius-sm);
  font-size: 0.85rem;
  font-weight: 600;
  transition: all 0.15s ease;
}

.btn-primary {
  background: var(--protein);
  color: #fff;
}
.btn-primary:active { opacity: 0.8; transform: scale(0.97); }

.btn-secondary {
  background: var(--badge-bg);
  color: var(--text-secondary);
}
.btn-secondary:active { opacity: 0.7; }

.btn-danger {
  background: rgba(244,67,54,0.15);
  color: var(--calories);
}

.btn-small {
  min-height: 36px;
  padding: 6px 12px;
  font-size: 0.75rem;
}

.btn-group {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}

/* Expandable sections */
.expandable-trigger {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 0.75rem;
  color: var(--text-secondary);
  padding: 4px 0;
  cursor: pointer;
}

.expandable-trigger::before {
  content: '\25B6';
  font-size: 0.55rem;
  transition: transform 0.2s ease;
}

.expandable-trigger.open::before {
  transform: rotate(90deg);
}

.expandable-content {
  display: none;
  padding: 8px 0 4px;
}

.expandable-content.open { display: block; }

/* Ingredient list */
.ingredient-list {
  list-style: none;
  padding: 0;
}

.ingredient-list li {
  font-size: 0.75rem;
  color: var(--text-secondary);
  padding: 3px 0;
  display: flex;
  justify-content: space-between;
}

.ingredient-list li .qty {
  color: var(--text-muted);
  font-variant-numeric: tabular-nums;
}

/* Rating buttons */
.rating-group {
  display: flex;
  gap: 6px;
}

.rating-btn {
  min-width: 44px;
  min-height: 38px;
  border-radius: var(--radius-sm);
  font-size: 1.2rem;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--badge-bg);
  transition: all 0.15s ease;
}

.rating-btn.selected { background: var(--accent-soft); }
.rating-btn:active { transform: scale(0.92); }

/* Meal card states */
.meal-card.done {
  border-left: 3px solid var(--protein);
  background: var(--done-bg);
}

.meal-card.skipped {
  border-left: 3px solid var(--text-muted);
  background: var(--skip-bg);
  opacity: 0.65;
}

/* Day selector */
.day-selector {
  display: flex;
  gap: 6px;
  overflow-x: auto;
  padding: 8px 0 12px;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
}

.day-selector::-webkit-scrollbar { display: none; }

.day-chip {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  min-width: 48px;
  padding: 8px 6px;
  border-radius: var(--radius-sm);
  background: var(--bg-card);
  border: 2px solid transparent;
  font-size: 0.7rem;
  flex-shrink: 0;
  min-height: 44px;
  transition: all 0.15s ease;
}

.day-chip .day-label { font-weight: 600; font-size: 0.65rem; color: var(--text-secondary); }
.day-chip .day-num { font-weight: 700; font-size: 1rem; }
.day-chip.active { border-color: var(--accent); background: var(--accent-soft); }
.day-chip.today { box-shadow: 0 0 0 1px var(--accent); }
.day-chip.prep { background: rgba(33,150,243,0.08); }
.day-chip.prep .day-num { font-size: 0.7rem; }
.day-chip.completed-day::after {
  content: '\2713';
  font-size: 0.55rem;
  color: var(--protein);
}

/* Week toggle */
.week-toggle {
  display: flex;
  background: var(--bg-card);
  border-radius: var(--radius-sm);
  padding: 3px;
  margin-bottom: 12px;
}

.week-toggle-btn {
  flex: 1;
  min-height: 40px;
  border-radius: 6px;
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--text-secondary);
  transition: all 0.15s ease;
}

.week-toggle-btn.active {
  background: var(--accent);
  color: #fff;
}

/* Shopping item */
.shop-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
  min-height: 44px;
}

.shop-item.checked { opacity: 0.4; }
.shop-item.checked .shop-name { text-decoration: line-through; }

.shop-checkbox {
  width: 22px;
  height: 22px;
  border-radius: 6px;
  border: 2px solid var(--border-light);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: all 0.15s ease;
  cursor: pointer;
}

.shop-checkbox.checked {
  background: var(--protein);
  border-color: var(--protein);
}

.shop-checkbox.checked::after {
  content: '\2713';
  color: #fff;
  font-size: 0.75rem;
  font-weight: 700;
}

.shop-details { flex: 1; min-width: 0; }
.shop-name { font-size: 0.82rem; font-weight: 500; }
.shop-qty { font-size: 0.7rem; color: var(--text-secondary); margin-top: 1px; }
.shop-price { font-size: 0.82rem; font-weight: 600; font-variant-numeric: tabular-nums; flex-shrink: 0; }

.category-header {
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--text-muted);
  padding: 12px 0 4px;
}

/* Running total bar */
.total-bar {
  position: sticky;
  top: 0;
  z-index: 10;
  background: var(--bg-secondary);
  padding: 10px 14px;
  border-radius: var(--radius);
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: var(--shadow);
}

.total-bar .total-label { font-size: 0.8rem; color: var(--text-secondary); }
.total-bar .total-amount { font-size: 1.1rem; font-weight: 700; }

/* Inventory item */
.inv-item {
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
}

.inv-item-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.inv-name { font-size: 0.82rem; font-weight: 500; }
.inv-qty { font-size: 0.75rem; color: var(--text-secondary); font-variant-numeric: tabular-nums; }

.inv-item.low .inv-name { color: var(--calories); }
.inv-item.out { opacity: 0.35; }

/* Stats cards */
.stat-card {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 14px;
  margin-bottom: 10px;
  box-shadow: var(--shadow);
}

.stat-card-title {
  font-size: 0.7rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  color: var(--text-muted);
  margin-bottom: 8px;
}

.stat-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.stat-value {
  font-size: 1.4rem;
  font-weight: 700;
  line-height: 1.1;
}

.stat-unit {
  font-size: 0.7rem;
  color: var(--text-secondary);
  margin-top: 2px;
}

/* Day macro comparison bar chart */
.day-bars {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin: 8px 0;
}

.day-bar-row {
  display: flex;
  align-items: center;
  gap: 6px;
}

.day-bar-label {
  font-size: 0.7rem;
  width: 32px;
  text-align: right;
  flex-shrink: 0;
  color: var(--text-secondary);
}

.day-bar-track {
  flex: 1;
  height: 20px;
  background: var(--progress-bg);
  border-radius: 4px;
  position: relative;
  overflow: hidden;
}

.day-bar-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.4s ease;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding-right: 6px;
  font-size: 0.65rem;
  font-weight: 600;
  color: rgba(255,255,255,0.9);
  min-width: 28px;
}

.day-bar-target {
  position: absolute;
  top: 0;
  bottom: 0;
  width: 2px;
  background: rgba(255,255,255,0.4);
}

/* Modal/overlay for adjust */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: var(--overlay);
  z-index: 200;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  animation: fadeIn 0.15s ease;
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

.modal-sheet {
  background: var(--bg-secondary);
  border-radius: var(--radius) var(--radius) 0 0;
  padding: 20px 16px calc(16px + env(safe-area-inset-bottom, 0));
  width: 100%;
  max-width: 420px;
  animation: slideUp 0.2s ease;
}

.modal-title {
  font-size: 1rem;
  font-weight: 700;
  margin-bottom: 16px;
}

.modal-input-group {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 16px;
}

.modal-input {
  flex: 1;
  height: 44px;
  border: 1px solid var(--border-light);
  border-radius: var(--radius-sm);
  background: var(--bg-input);
  color: var(--text-primary);
  font-size: 1rem;
  padding: 0 12px;
  font-family: var(--font);
  text-align: center;
  font-variant-numeric: tabular-nums;
}

.modal-input:focus { outline: none; border-color: var(--accent); }

.modal-adj-btn {
  width: 44px;
  height: 44px;
  border-radius: var(--radius-sm);
  background: var(--badge-bg);
  font-size: 1.2rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-adj-btn:active { opacity: 0.7; }

.modal-actions {
  display: flex;
  gap: 8px;
}

.modal-actions .btn { flex: 1; }

/* Section title */
.section-title {
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--text-muted);
  margin: 16px 0 8px;
}

/* Prep day banner */
.prep-banner {
  background: rgba(33,150,243,0.08);
  border: 1px solid rgba(33,150,243,0.2);
  border-radius: var(--radius);
  padding: 14px;
  margin-bottom: 10px;
}

.prep-banner h3 {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--fat);
  margin-bottom: 6px;
}

.prep-banner p {
  font-size: 0.78rem;
  color: var(--text-secondary);
  line-height: 1.5;
}

/* Day complete celebration */
.day-complete {
  text-align: center;
  padding: 24px 16px;
}

.day-complete .icon { font-size: 2.5rem; margin-bottom: 8px; }
.day-complete h3 { font-size: 1.1rem; font-weight: 700; margin-bottom: 4px; }
.day-complete p { font-size: 0.82rem; color: var(--text-secondary); }

/* Empty state */
.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--text-secondary);
}

.empty-state .icon { font-size: 2rem; margin-bottom: 8px; }
.empty-state h3 { font-size: 1rem; margin-bottom: 4px; color: var(--text-primary); }
.empty-state p { font-size: 0.82rem; }

/* Loading */
#loading {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100dvh;
  font-size: 0.9rem;
  color: var(--text-secondary);
}

/* Macro donut (simple CSS) */
.donut-container {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 16px;
  padding: 8px 0;
}

.donut {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  position: relative;
  flex-shrink: 0;
}

.donut-center {
  position: absolute;
  inset: 20px;
  border-radius: 50%;
  background: var(--bg-card);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.donut-center .value { font-size: 1rem; font-weight: 700; }
.donut-center .label { font-size: 0.55rem; color: var(--text-secondary); }

.donut-legend {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.donut-legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.75rem;
}

.donut-legend-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

/* Adherence mini bars */
.adherence-row {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 0;
}

.adherence-day {
  font-size: 0.65rem;
  width: 18px;
  text-align: right;
  color: var(--text-secondary);
  flex-shrink: 0;
}

.adherence-bar {
  flex: 1;
  height: 14px;
  background: var(--progress-bg);
  border-radius: 3px;
  overflow: hidden;
}

.adherence-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.3s ease;
}

/* Settings panel */
.settings-btn {
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: var(--radius-sm);
  font-size: 1.1rem;
  color: var(--text-secondary);
  transition: all 0.15s ease;
  flex-shrink: 0;
}

.settings-btn:active { opacity: 0.7; }

.settings-panel {
  display: none;
  position: fixed;
  top: var(--header-height);
  right: 0;
  width: 100%;
  max-width: 360px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
  border-left: 1px solid var(--border);
  box-shadow: var(--shadow-lg);
  z-index: 150;
  padding: 16px;
  animation: slideDown 0.15s ease;
}

.settings-panel.open { display: block; }

@keyframes slideDown { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }

.settings-section {
  margin-bottom: 16px;
}

.settings-section-title {
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--text-muted);
  margin-bottom: 8px;
}

.settings-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}

.settings-row input[type="email"] {
  flex: 1;
  height: 40px;
  border: 1px solid var(--border-light);
  border-radius: var(--radius-sm);
  background: var(--bg-input);
  color: var(--text-primary);
  font-size: 0.85rem;
  padding: 0 12px;
  font-family: var(--font);
}

.settings-row input[type="email"]:focus { outline: none; border-color: var(--accent); }

.auth-status {
  font-size: 0.8rem;
  color: var(--text-secondary);
  padding: 8px 0;
}

.auth-status .email {
  color: var(--protein);
  font-weight: 600;
}

.auth-msg {
  font-size: 0.75rem;
  padding: 6px 0;
  color: var(--text-secondary);
}

.auth-msg.success { color: var(--protein); }
.auth-msg.error { color: var(--calories); }

/* Offline indicator */
.offline-badge {
  display: none;
  align-items: center;
  gap: 4px;
  font-size: 0.65rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  color: var(--calories);
  background: rgba(244,67,54,0.1);
  padding: 3px 8px;
  border-radius: 4px;
}

.offline-badge.visible { display: inline-flex; }

/* Sync indicator */
.sync-badge {
  display: none;
  align-items: center;
  gap: 4px;
  font-size: 0.65rem;
  font-weight: 600;
  color: var(--text-muted);
  padding: 3px 8px;
}

.sync-badge.visible { display: inline-flex; }

#header-right {
  display: flex;
  align-items: center;
  gap: 6px;
}

.today-day-nav {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 8px 4px;
  margin-bottom: 10px;
}

.today-nav-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: 1px solid var(--border);
  background: var(--bg-primary);
  color: var(--text-primary);
  font-size: 1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.today-nav-btn:disabled {
  opacity: 0.25;
  cursor: default;
}

.today-nav-center {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
}

.today-nav-day {
  font-weight: 700;
  font-size: 0.95rem;
}

.today-nav-date {
  font-size: 0.75rem;
  color: var(--text-secondary);
}
</style>
</head>
<body>
<div id="loading">Loading meal plan...</div>
<div id="app" style="display:none">
  <header id="app-header">
    <h1 id="header-title">Meal Plan</h1>
    <div id="header-right">
      <span id="offline-badge" class="offline-badge">Offline</span>
      <span id="sync-badge" class="sync-badge"></span>
      <span id="header-info"></span>
      <button id="settings-btn" class="settings-btn" aria-label="Settings">&#9881;</button>
    </div>
  </header>
  <div id="settings-panel" class="settings-panel">
    <div class="settings-section">
      <div class="settings-section-title">Sync Account</div>
      <div id="auth-signed-out">
        <div class="settings-row">
          <input type="email" id="auth-email" placeholder="you@email.com" autocomplete="email">
          <button class="btn btn-primary btn-small" id="auth-signin-btn">Sign in</button>
        </div>
        <div id="auth-msg" class="auth-msg"></div>
        <div style="font-size:0.7rem;color:var(--text-muted);margin-top:4px">Sign in to sync across devices. A magic link will be emailed to you.</div>
      </div>
      <div id="auth-signed-in" style="display:none">
        <div class="auth-status">Signed in as <span class="email" id="auth-user-email"></span></div>
        <div id="auth-sync-status" class="auth-msg"></div>
        <div style="display:flex;gap:6px;margin-top:6px">
          <button class="btn btn-secondary btn-small" id="auth-sync-now-btn">Sync now</button>
          <button class="btn btn-secondary btn-small" id="auth-signout-btn">Sign out</button>
        </div>
      </div>
    </div>
  </div>
  <main id="tab-content"></main>
  <nav id="bottom-nav">
    <button data-tab="today" class="nav-btn active">
      <span class="nav-icon">&#9728;</span>
      <span class="nav-label">Today</span>
    </button>
    <button data-tab="plan" class="nav-btn">
      <span class="nav-icon">&#128203;</span>
      <span class="nav-label">Plan</span>
    </button>
    <button data-tab="shop" class="nav-btn">
      <span class="nav-icon">&#128722;</span>
      <span class="nav-label">Shop</span>
    </button>
    <button data-tab="stock" class="nav-btn">
      <span class="nav-icon">&#128230;</span>
      <span class="nav-label">Stock</span>
    </button>
    <button data-tab="stats" class="nav-btn">
      <span class="nav-icon">&#128202;</span>
      <span class="nav-label">Stats</span>
    </button>
  </nav>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>

// === BUILD: Embedded product catalog ===
const __CATALOG__ = {
  "meta": {
    "store": "Woolworths South Africa",
    "currency": "ZAR",
    "lastUpdated": "2026-02-22",
    "purpose": "Hypertrophy meal plan product catalog",
    "notes": "Prices verified from woolworths.co.za, nutrition from fatsecret.co.za. Per 100g unless noted."
  },
  "products": [
    {
      "id": "chicken-breast",
      "name": "Skinless Chicken Breast Fillets",
      "woolworthsName": "Skinless Chicken Breast Fillets Avg 900 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-2084930000000",
      "fatSecretUrl": "https://www.fatsecret.co.za/calories-nutrition/woolworths/skinless-chicken-breast-fillets/100g",
      "category": "protein",
      "subcategory": "poultry",
      "packSize_g": 900,
      "cookingYield": 0.75,
      "priceZAR": 125.54,
      "per100g": {
        "calories": 106,
        "protein_g": 24.8,
        "carbs_g": 0.0,
        "fat_g": 1.0,
        "fibre_g": 0.0
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "fatsecret.co.za",
        "confidence": "high"
      },
      "notes": "Best value lean protein. Versatile for meal prep."
    },
    {
      "id": "chicken-drumsticks-thighs",
      "name": "Chicken Drumsticks & Thighs",
      "woolworthsName": "Chicken Drumsticks & Thighs Avg 900 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-2084900000009",
      "fatSecretUrl": "https://www.fatsecret.co.za/calories-nutrition/woolworths/chicken-thigh-fillet/100g",
      "category": "protein",
      "subcategory": "poultry",
      "packSize_g": 900,
      "cookingYield": 0.70,
      "priceZAR": 101.19,
      "per100g": {
        "calories": 119,
        "protein_g": 18.3,
        "carbs_g": 0.0,
        "fat_g": 5.0,
        "fibre_g": 0.0
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "fatsecret.co.za",
        "confidence": "medium"
      },
      "notes": "FatSecret match is boneless thigh fillet; bone-in drumsticks/thighs have different edible yield. Budget-friendly protein."
    },
    {
      "id": "lean-beef-mince",
      "name": "Lean Beef Mince",
      "woolworthsName": "Lean Beef Mince 1 kg",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-20144807",
      "fatSecretUrl": "https://www.fatsecret.co.za/calories-nutrition/woolworths/lean-beef-mince/100g",
      "category": "protein",
      "subcategory": "beef",
      "packSize_g": 1000,
      "cookingYield": 0.70,
      "priceZAR": 159.99,
      "per100g": {
        "calories": 167,
        "protein_g": 20.2,
        "carbs_g": 0.0,
        "fat_g": 8.4,
        "fibre_g": 0.0
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "fatsecret.co.za",
        "confidence": "high"
      },
      "notes": "Max 10% fat label. Great for bolognese, burgers, and meatballs."
    },
    {
      "id": "beef-sirloin",
      "name": "Beef Sirloin Steak",
      "woolworthsName": "Matured Thick Cut Beef Sirloin Steak Avg 550 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-2028910000000",
      "fatSecretUrl": "https://www.fatsecret.co.za/calories-nutrition/woolworths/sirloin-steak/100g",
      "category": "protein",
      "subcategory": "beef",
      "packSize_g": 550,
      "cookingYield": 0.75,
      "priceZAR": 148.49,
      "per100g": {
        "calories": 204,
        "protein_g": 19.2,
        "carbs_g": 0.0,
        "fat_g": 14.2,
        "fibre_g": 0.0
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "fatsecret.co.za",
        "confidence": "high"
      },
      "notes": "28-day matured. Higher fat than previously estimated — adjust meal plan portions accordingly."
    },
    {
      "id": "basa-fillets",
      "name": "Basa Fillets",
      "woolworthsName": "Basa Fillets Avg 350 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-2565090000005",
      "fatSecretUrl": "https://www.fatsecret.co.za/calories-nutrition/woolworths/basa-fillet/100g",
      "category": "protein",
      "subcategory": "fish",
      "packSize_g": 350,
      "cookingYield": 0.80,
      "priceZAR": 87.00,
      "per100g": {
        "calories": 95,
        "protein_g": 18.0,
        "carbs_g": 0.0,
        "fat_g": 2.0,
        "fibre_g": 0.0
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "fatsecret.co.za",
        "confidence": "high"
      },
      "notes": "Affordable mild white fish. Farmed in Vietnam, deboned and skinless."
    },
    {
      "id": "hake-medallions",
      "name": "Hake Medallions Frozen",
      "woolworthsName": "Freshly Frozen Hake Medallions 450 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-6005000415087",
      "fatSecretUrl": "https://www.fatsecret.co.za/calories-nutrition/woolworths/hake-medallions/100g",
      "category": "protein",
      "subcategory": "fish",
      "packSize_g": 450,
      "cookingYield": 0.80,
      "priceZAR": 132.99,
      "per100g": {
        "calories": 71,
        "protein_g": 14.5,
        "carbs_g": 0.1,
        "fat_g": 1.4,
        "fibre_g": 0.3
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "fatsecret.co.za",
        "confidence": "high"
      },
      "notes": "Very lean white fish. Individually wrapped, min 6 medallions."
    },
    {
      "id": "salmon-portions",
      "name": "Salmon Portions",
      "woolworthsName": "Norwegian Salmon Portions 400 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-6005000430219",
      "fatSecretUrl": "https://www.fatsecret.co.za/calories-nutrition/woolworths/norwegian-salmon-portions/100g",
      "category": "protein",
      "subcategory": "fish",
      "packSize_g": 400,
      "cookingYield": 0.80,
      "priceZAR": 309.99,
      "per100g": {
        "calories": 222,
        "protein_g": 19.8,
        "carbs_g": 1.0,
        "fat_g": 15.4,
        "fibre_g": 0.3
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "fatsecret.co.za",
        "confidence": "high"
      },
      "notes": "Rich in omega-3. 4-pack, deboned, skin-on. Sustainably farmed in Norway."
    },
    {
      "id": "free-range-eggs",
      "name": "Free Range Large Eggs 18pk",
      "woolworthsName": "Free Range Large Eggs 18 pk",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-20068929",
      "fatSecretUrl": "https://www.fatsecret.co.za/calories-nutrition/woolworths/large-free-range-eggs/1-egg",
      "category": "protein",
      "subcategory": "eggs",
      "packSize_g": 918,
      "priceZAR": 91.99,
      "per100g": {
        "calories": 127,
        "protein_g": 11.8,
        "carbs_g": 3.9,
        "fat_g": 7.8,
        "fibre_g": 1.0
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "fatsecret.co.za",
        "confidence": "medium"
      },
      "notes": "18 eggs at ~51g each = 918g. ~6g protein per egg. FatSecret per-egg data converted to per-100g; carbs/fibre seem high for eggs."
    },
    {
      "id": "liquid-egg-whites",
      "name": "Liquid Egg Whites",
      "woolworthsName": "Free Range Liquid Egg Whites 1 L",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-6009207282732",
      "fatSecretUrl": "https://www.fatsecret.co.za/calories-nutrition/woolworths/liquid-egg-whites/100ml",
      "category": "protein",
      "subcategory": "eggs",
      "packSize_g": 1000,
      "priceZAR": 139.99,
      "per100g": {
        "calories": 46,
        "protein_g": 11.0,
        "carbs_g": 0.0,
        "fat_g": 0.1,
        "fibre_g": 0.0
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "fatsecret.co.za",
        "confidence": "high"
      },
      "notes": "Pure protein, virtually zero fat. Contains ~33 egg whites per litre."
    },
    {
      "id": "cottage-cheese-fat-free",
      "name": "Fat Free Smooth Plain Cottage Cheese",
      "woolworthsName": "Organic Fat Free Smooth Plain Cottage Cheese 250 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-20130084",
      "fatSecretUrl": "https://www.fatsecret.co.za/calories-nutrition/woolworths/fat-free-smooth-plain-cottage-cheese/100g",
      "category": "protein",
      "subcategory": "dairy",
      "packSize_g": 250,
      "priceZAR": 50.99,
      "per100g": {
        "calories": 71,
        "protein_g": 11.1,
        "carbs_g": 3.0,
        "fat_g": 1.6,
        "fibre_g": 0.0
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "fatsecret.co.za",
        "confidence": "high"
      },
      "notes": "All Woolworths cottage cheese is organic. Good as a snack or mixed into meals."
    },
    {
      "id": "fat-free-yoghurt",
      "name": "Fat Free Ayrshire Plain Yoghurt",
      "woolworthsName": "Fat Free Ayrshire Plain Yoghurt 1 kg",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-20125301",
      "fatSecretUrl": "https://www.fatsecret.co.za/calories-nutrition/woolworths/fat-free-plain-yoghurt/100g",
      "category": "protein",
      "subcategory": "dairy",
      "packSize_g": 1000,
      "priceZAR": 51.99,
      "per100g": {
        "calories": 38,
        "protein_g": 3.5,
        "carbs_g": 5.0,
        "fat_g": 0.4,
        "fibre_g": 0.5
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "fatsecret.co.za",
        "confidence": "high"
      },
      "notes": "WARNING: Previous catalog had 10.3g protein — actual is only 3.5g. NOT a high-protein food. Contains live Bifidobacterium cultures."
    },
    {
      "id": "double-cream-yoghurt",
      "name": "Double Cream Plain Yoghurt",
      "woolworthsName": "Double Cream Plain Yoghurt 1 kg",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-20185589",
      "fatSecretUrl": "https://www.fatsecret.co.za/calories-nutrition/woolworths/double-cream-plain-yoghurt/100g",
      "category": "protein",
      "subcategory": "dairy",
      "packSize_g": 1000,
      "priceZAR": 54.99,
      "per100g": {
        "calories": 94,
        "protein_g": 3.6,
        "carbs_g": 5.0,
        "fat_g": 6.7,
        "fibre_g": 0.0
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "fatsecret.co.za",
        "confidence": "high"
      },
      "notes": "Higher fat yoghurt. No preservatives, contains live cultures."
    },
    {
      "id": "high-protein-milk",
      "name": "Low Fat High Protein Milk",
      "woolworthsName": "Ayrshire Low Fat High Protein Milk 350 ml",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-6009226684760",
      "fatSecretUrl": "https://www.fatsecret.co.za/calories-nutrition/woolworths/high-protein-ayrshire-low-fat-milk/100ml",
      "category": "protein",
      "subcategory": "dairy",
      "packSize_g": 350,
      "priceZAR": 34.99,
      "per100g": {
        "calories": 53,
        "protein_g": 7.1,
        "carbs_g": 4.0,
        "fat_g": 1.0,
        "fibre_g": 0.0
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "fatsecret.co.za",
        "confidence": "high"
      },
      "notes": "~25g protein per 350ml bottle. Previous catalog understated protein (4.3g vs actual 7.1g per 100ml)."
    },
    {
      "id": "beef-biltong",
      "name": "Sliced Beef Biltong",
      "woolworthsName": "Sliced Beef Biltong 150 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-20000851",
      "fatSecretUrl": "https://www.fatsecret.co.za/calories-nutrition/woolworths/beef-biltong-sliced/100g",
      "category": "protein",
      "subcategory": "beef",
      "packSize_g": 150,
      "priceZAR": 109.99,
      "per100g": {
        "calories": 314,
        "protein_g": 40.5,
        "carbs_g": 3.0,
        "fat_g": 15.6,
        "fibre_g": 0.3
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "fatsecret.co.za",
        "confidence": "high"
      },
      "notes": "Extremely protein dense. Traditional mildly spiced. High sodium (1438mg/100g)."
    },
    {
      "id": "pork-rashers",
      "name": "Smoked Pork Rashers",
      "woolworthsName": "Smoked Pork Rashers Avg 400 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-2071580000009",
      "fatSecretUrl": "https://www.fatsecret.co.za/calories-nutrition/woolworths/pork-rashers/100g",
      "category": "protein",
      "subcategory": "pork",
      "packSize_g": 400,
      "cookingYield": 0.65,
      "priceZAR": 63.00,
      "per100g": {
        "calories": 235,
        "protein_g": 17.2,
        "carbs_g": 0.0,
        "fat_g": 18.7,
        "fibre_g": 0.0
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "fatsecret.co.za",
        "confidence": "high"
      },
      "notes": "Pack size changed from ~200g to 400g. Oak-smoked South African pork belly. Higher fat protein source."
    },
    {
      "id": "chicken-lasagne",
      "name": "Chicken Lasagne Ready Meal",
      "woolworthsName": "Chicken Lasagne 350 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-6001009000811",
      "fatSecretUrl": null,
      "category": "protein",
      "subcategory": "ready-meal",
      "packSize_g": 350,
      "priceZAR": 86.99,
      "per100g": {
        "calories": 148,
        "protein_g": 11.5,
        "carbs_g": 12.8,
        "fat_g": 5.9,
        "fibre_g": 0.8
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "estimated",
        "confidence": "medium"
      },
      "notes": "Nutrition estimated — check packaging. Microwave 2.5 min. Serves 1."
    },
    {
      "id": "chicken-a-la-king",
      "name": "Chicken a la King Ready Meal",
      "woolworthsName": "Chicken A La King with Rice 400 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-20139797",
      "fatSecretUrl": null,
      "category": "protein",
      "subcategory": "ready-meal",
      "packSize_g": 400,
      "priceZAR": 104.99,
      "per100g": {
        "calories": 126,
        "protein_g": 9.8,
        "carbs_g": 8.5,
        "fat_g": 5.6,
        "fibre_g": 0.6
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "estimated",
        "confidence": "medium"
      },
      "notes": "Includes rice. Nutrition estimated — check packaging."
    },
    {
      "id": "spaghetti-bolognese",
      "name": "Spaghetti Bolognese Ready Meal",
      "woolworthsName": "Spaghetti Bolognese 350 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-20152123",
      "fatSecretUrl": null,
      "category": "protein",
      "subcategory": "ready-meal",
      "packSize_g": 350,
      "priceZAR": 84.99,
      "per100g": {
        "calories": 118,
        "protein_g": 8.2,
        "carbs_g": 10.4,
        "fat_g": 4.8,
        "fibre_g": 1.2
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "estimated",
        "confidence": "medium"
      },
      "notes": "Previously listed as 'Beef Bolognese 400g'. Actual product is Spaghetti Bolognese 350g with pasta and cheese. Check packaging for macros."
    },
    {
      "id": "whey-protein",
      "name": "Whey Protein Powder",
      "woolworthsName": "Whey Protein Concentrate (generic, e.g. USN/NPL)",
      "woolworthsUrl": null,
      "fatSecretUrl": null,
      "category": "protein",
      "subcategory": "supplement",
      "packSize_g": 908,
      "priceZAR": 449.99,
      "per100g": {
        "calories": 387,
        "protein_g": 80.0,
        "carbs_g": 6.7,
        "fat_g": 4.0,
        "fibre_g": 0.0
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "manual",
        "nutritionSource": "product-label",
        "confidence": "manual"
      },
      "notes": "~24g protein per 30g scoop. Not a Woolworths product — verify price at preferred retailer."
    },
    {
      "id": "white-basmati-rice",
      "name": "White Basmati Rice",
      "woolworthsName": "Basmati Rice 1 kg",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-6009211697751",
      "fatSecretUrl": "https://www.fatsecret.co.za/calories-nutrition/woolworths/basmati-rice/100g",
      "category": "carbs",
      "subcategory": "grain",
      "packSize_g": 1000,
      "cookingYield": 2.5,
      "priceZAR": 79.99,
      "per100g": {
        "calories": 355,
        "protein_g": 9.2,
        "carbs_g": 74.0,
        "fat_g": 1.2,
        "fibre_g": 0.4
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "fatsecret.co.za",
        "confidence": "high"
      },
      "notes": "Dry weight values. ~130 kcal per 100g cooked. PRICE INCREASED from R49.99 to R79.99."
    },
    {
      "id": "brown-rice",
      "name": "Long Grain Brown Rice",
      "woolworthsName": "Long Grain Brown Rice 1 kg",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-6009211697744",
      "fatSecretUrl": null,
      "category": "carbs",
      "subcategory": "grain",
      "packSize_g": 1000,
      "cookingYield": 2.5,
      "priceZAR": 43.99,
      "per100g": {
        "calories": 357,
        "protein_g": 7.5,
        "carbs_g": 76.2,
        "fat_g": 2.7,
        "fibre_g": 3.4
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "existing",
        "confidence": "medium"
      },
      "notes": "Dry weight values. ~123 kcal per 100g cooked. More fibre than white rice."
    },
    {
      "id": "sweet-potatoes",
      "name": "Sweet Potatoes",
      "woolworthsName": "Kara Sweet Potatoes 1 kg",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-20088835",
      "fatSecretUrl": null,
      "category": "carbs",
      "subcategory": "root-vegetable",
      "packSize_g": 1000,
      "cookingYield": 0.85,
      "priceZAR": 31.99,
      "per100g": {
        "calories": 86,
        "protein_g": 1.6,
        "carbs_g": 20.1,
        "fat_g": 0.1,
        "fibre_g": 3.0
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "generic",
        "confidence": "medium"
      },
      "notes": "Raw values. Purple skin, white flesh. Good complex carb source."
    },
    {
      "id": "rolled-oats",
      "name": "Rolled Oats",
      "woolworthsName": "Rolled Oats 1 kg",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-6009101343263",
      "fatSecretUrl": "https://www.fatsecret.co.za/calories-nutrition/woolworths/rolled-oats/100g",
      "category": "carbs",
      "subcategory": "grain",
      "packSize_g": 1000,
      "cookingYield": 2.5,
      "priceZAR": 51.99,
      "per100g": {
        "calories": 380,
        "protein_g": 12.1,
        "carbs_g": 61.0,
        "fat_g": 7.6,
        "fibre_g": 10.1
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "fatsecret.co.za",
        "confidence": "high"
      },
      "notes": "Dry weight. PRICE INCREASED from R36.99 to R51.99. Vegan, high fibre, halaal, kosher."
    },
    {
      "id": "wholewheat-bread",
      "name": "Wholewheat Bread",
      "woolworthsName": "High Fibre Wholewheat Brown Bread 700 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-6009204921979",
      "fatSecretUrl": null,
      "category": "carbs",
      "subcategory": "bread",
      "packSize_g": 700,
      "priceZAR": 26.99,
      "per100g": {
        "calories": 247,
        "protein_g": 10.7,
        "carbs_g": 42.5,
        "fat_g": 3.4,
        "fibre_g": 6.8
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "existing",
        "confidence": "medium"
      },
      "notes": "Higher fibre than white bread. Good for sandwiches and toast."
    },
    {
      "id": "white-bread",
      "name": "White Bread",
      "woolworthsName": "White Thick Slice Bread 700 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-20018702",
      "fatSecretUrl": null,
      "category": "carbs",
      "subcategory": "bread",
      "packSize_g": 700,
      "priceZAR": 21.99,
      "per100g": {
        "calories": 264,
        "protein_g": 8.9,
        "carbs_g": 49.2,
        "fat_g": 3.1,
        "fibre_g": 2.4
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "existing",
        "confidence": "medium"
      },
      "notes": "Quick-digesting carb. Good around workouts."
    },
    {
      "id": "penne-pasta",
      "name": "Penne Pasta",
      "woolworthsName": "Penne Pasta 500 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-20074555",
      "fatSecretUrl": "https://www.fatsecret.co.za/calories-nutrition/woolworths/penne-pasta/100g",
      "category": "carbs",
      "subcategory": "pasta",
      "packSize_g": 500,
      "cookingYield": 2.0,
      "priceZAR": 49.99,
      "per100g": {
        "calories": 364,
        "protein_g": 10.5,
        "carbs_g": 74.0,
        "fat_g": 1.7,
        "fibre_g": 3.2
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "fatsecret.co.za",
        "confidence": "high"
      },
      "notes": "Dry weight. PRICE DOUBLED from R23.99 to R49.99. Premium bronze die-cut, made in Italy."
    },
    {
      "id": "spaghetti",
      "name": "Spaghetti",
      "woolworthsName": "Spaghettoni 500 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-20164409",
      "fatSecretUrl": "https://www.fatsecret.co.za/calories-nutrition/woolworths/penne-pasta/100g",
      "category": "carbs",
      "subcategory": "pasta",
      "packSize_g": 500,
      "cookingYield": 2.0,
      "priceZAR": 49.99,
      "per100g": {
        "calories": 364,
        "protein_g": 10.5,
        "carbs_g": 74.0,
        "fat_g": 1.7,
        "fibre_g": 3.2
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "fatsecret.co.za",
        "confidence": "high"
      },
      "notes": "Dry weight. Same macros as penne. PRICE DOUBLED from R23.99 to R49.99."
    },
    {
      "id": "baby-potatoes",
      "name": "Baby Potatoes",
      "woolworthsName": "Baby Potatoes 700 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-20008123",
      "fatSecretUrl": null,
      "category": "carbs",
      "subcategory": "root-vegetable",
      "packSize_g": 700,
      "cookingYield": 0.90,
      "priceZAR": 24.99,
      "per100g": {
        "calories": 77,
        "protein_g": 2.0,
        "carbs_g": 17.5,
        "fat_g": 0.1,
        "fibre_g": 2.2
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "generic",
        "confidence": "medium"
      },
      "notes": "Pack size changed from 1kg to 700g. Raw values. Easy to roast or boil."
    },
    {
      "id": "bananas",
      "name": "Bananas",
      "woolworthsName": "Small Bananas Minimum 800 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-20102951",
      "fatSecretUrl": null,
      "category": "carbs",
      "subcategory": "fruit",
      "packSize_g": 800,
      "priceZAR": 28.99,
      "per100g": {
        "calories": 89,
        "protein_g": 1.1,
        "carbs_g": 22.8,
        "fat_g": 0.3,
        "fibre_g": 2.6
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "generic",
        "confidence": "medium"
      },
      "notes": "Sold as min 800g pack, not per kg. Quick energy, good pre/post workout."
    },
    {
      "id": "futurelife-cereal",
      "name": "Futurelife High Protein Cereal",
      "woolworthsName": "Futurelife High Protein Smart Food Chocolate Flavoured Cereal 500 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-6009801741529",
      "fatSecretUrl": null,
      "category": "carbs",
      "subcategory": "cereal",
      "packSize_g": 500,
      "priceZAR": 99.99,
      "per100g": {
        "calories": 393,
        "protein_g": 30.0,
        "carbs_g": 47.5,
        "fat_g": 7.8,
        "fibre_g": 5.3
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "product-label",
        "confidence": "medium"
      },
      "notes": "High protein cereal. Mix with water or milk. Fortified with 23 vitamins and minerals."
    },
    {
      "id": "avocado",
      "name": "Avocados",
      "woolworthsName": "Ripen at Home Avocados 1 kg",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-20144432",
      "fatSecretUrl": null,
      "category": "fats",
      "subcategory": "fruit",
      "packSize_g": 1000,
      "priceZAR": 78.99,
      "per100g": {
        "calories": 160,
        "protein_g": 2.0,
        "carbs_g": 8.5,
        "fat_g": 14.7,
        "fibre_g": 6.7
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "generic",
        "confidence": "medium"
      },
      "notes": "Sold as 1kg pack (~5-6 avocados). Class 1, thin easy-to-peel skin. ~80% edible flesh."
    },
    {
      "id": "mixed-nuts",
      "name": "Roasted & Salted Assorted Nuts",
      "woolworthsName": "Roasted & Salted Assorted Nuts With Peanuts 550 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-20160135",
      "fatSecretUrl": null,
      "category": "fats",
      "subcategory": "nuts",
      "packSize_g": 550,
      "priceZAR": 181.99,
      "per100g": {
        "calories": 607,
        "protein_g": 20.2,
        "carbs_g": 16.8,
        "fat_g": 52.5,
        "fibre_g": 6.9
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "existing",
        "confidence": "medium"
      },
      "notes": "Pack size changed from 250g to 550g. 50% peanuts + 50% tree nuts. Calorie dense."
    },
    {
      "id": "peanut-butter",
      "name": "Peanut Butter",
      "woolworthsName": "Crunchy Peanut Butter 400 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-20026677",
      "fatSecretUrl": null,
      "category": "fats",
      "subcategory": "nut-butter",
      "packSize_g": 400,
      "priceZAR": 51.99,
      "per100g": {
        "calories": 588,
        "protein_g": 25.1,
        "carbs_g": 14.3,
        "fat_g": 49.9,
        "fibre_g": 6.0
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "existing",
        "confidence": "medium"
      },
      "notes": "Calorie dense with decent protein. Great on toast, in oats, or smoothies."
    },
    {
      "id": "olive-oil",
      "name": "Extra Virgin Olive Oil",
      "woolworthsName": "Extra Virgin Olive Oil 500 ml",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-6009204330849",
      "fatSecretUrl": null,
      "category": "fats",
      "subcategory": "oil",
      "packSize_g": 460,
      "priceZAR": 109.95,
      "per100g": {
        "calories": 884,
        "protein_g": 0,
        "carbs_g": 0,
        "fat_g": 100.0,
        "fibre_g": 0
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "generic",
        "confidence": "high"
      },
      "notes": "500ml bottle (~460g). Costa brand. Use for cooking and dressings."
    },
    {
      "id": "cheddar-cheese",
      "name": "Cheddar Cheese",
      "woolworthsName": "Cheddar Cheese 400 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-6009101877430",
      "fatSecretUrl": null,
      "category": "fats",
      "subcategory": "dairy",
      "packSize_g": 400,
      "priceZAR": 94.99,
      "per100g": {
        "calories": 403,
        "protein_g": 24.9,
        "carbs_g": 1.3,
        "fat_g": 33.1,
        "fibre_g": 0
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "existing",
        "confidence": "medium"
      },
      "notes": "PRICE INCREASED from R79.99 to R94.99. Matured min 4 months. Award winning."
    },
    {
      "id": "butter",
      "name": "Butter",
      "woolworthsName": "Salted Butter 250 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-20011833",
      "fatSecretUrl": null,
      "category": "fats",
      "subcategory": "dairy",
      "packSize_g": 250,
      "priceZAR": 65.99,
      "per100g": {
        "calories": 717,
        "protein_g": 0.9,
        "carbs_g": 0.1,
        "fat_g": 81.1,
        "fibre_g": 0
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "existing",
        "confidence": "medium"
      },
      "notes": "PRICE INCREASED from R47.99 to R65.99 (+38%). Smooth and creamy, Breede River Valley."
    },
    {
      "id": "frozen-mixed-veg",
      "name": "Frozen Mixed Vegetables",
      "woolworthsName": "Freshly Frozen Diced Vegetable Mix 1 kg",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-20159207",
      "fatSecretUrl": null,
      "category": "vegetables",
      "subcategory": "frozen",
      "packSize_g": 1000,
      "priceZAR": 64.99,
      "per100g": {
        "calories": 52,
        "protein_g": 2.6,
        "carbs_g": 8.5,
        "fat_g": 0.3,
        "fibre_g": 3.3
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "existing",
        "confidence": "medium"
      },
      "notes": "PRICE INCREASED from R44.99 to R64.99 (+44%). Carrots, peas, green beans, sweetcorn."
    },
    {
      "id": "frozen-broccoli",
      "name": "Frozen Broccoli Florets",
      "woolworthsName": "Frozen Broccoli Florets 400g",
      "woolworthsUrl": null,
      "fatSecretUrl": null,
      "category": "vegetables",
      "subcategory": "frozen",
      "packSize_g": 400,
      "priceZAR": 34.99,
      "per100g": {
        "calories": 34,
        "protein_g": 2.8,
        "carbs_g": 4.0,
        "fat_g": 0.4,
        "fibre_g": 2.6
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "not found",
        "nutritionSource": "existing",
        "confidence": "low"
      },
      "notes": "FLAGGED: Not found on woolworths.co.za as standalone frozen product. May be discontinued or seasonal. Country Crop Mix 1kg (R64.99) includes broccoli. Also note: user has broccoli restriction."
    },
    {
      "id": "frozen-spinach",
      "name": "Chopped Spinach",
      "woolworthsName": "Bulk Chopped Spinach 400 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-6009175022859",
      "fatSecretUrl": null,
      "category": "vegetables",
      "subcategory": "fresh",
      "packSize_g": 400,
      "priceZAR": 42.99,
      "per100g": {
        "calories": 23,
        "protein_g": 2.9,
        "carbs_g": 1.6,
        "fat_g": 0.4,
        "fibre_g": 2.2
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "existing",
        "confidence": "medium"
      },
      "notes": "PRICE INCREASED from R29.99 to R42.99. Note: this is FRESH chopped spinach, not frozen. Destalked and deveined."
    },
    {
      "id": "frozen-butternut",
      "name": "Diced Butternut",
      "woolworthsName": "Bulk Diced Butternut 800 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-20111762",
      "fatSecretUrl": null,
      "category": "vegetables",
      "subcategory": "fresh",
      "packSize_g": 800,
      "cookingYield": 0.80,
      "priceZAR": 49.99,
      "per100g": {
        "calories": 45,
        "protein_g": 1.0,
        "carbs_g": 10.5,
        "fat_g": 0.1,
        "fibre_g": 2.0
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "existing",
        "confidence": "medium"
      },
      "notes": "CHANGED: Was 'Frozen Butternut Cubes 600g R36.99'. Now 'Bulk Diced Butternut 800g R49.99' (fresh, not frozen)."
    },
    {
      "id": "canned-tomatoes",
      "name": "Canned Diced Tomatoes",
      "woolworthsName": "Diced Tomatoes 400 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-20108809",
      "fatSecretUrl": null,
      "category": "vegetables",
      "subcategory": "canned",
      "packSize_g": 400,
      "priceZAR": 28.99,
      "per100g": {
        "calories": 19,
        "protein_g": 0.9,
        "carbs_g": 3.5,
        "fat_g": 0.1,
        "fibre_g": 0.9
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "existing",
        "confidence": "medium"
      },
      "notes": "Italian pomodori tomatoes. Price up from R22.99 to R28.99."
    },
    {
      "id": "mushrooms",
      "name": "Button Mushrooms",
      "woolworthsName": "Button Mushrooms 250 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-20008918",
      "fatSecretUrl": null,
      "category": "vegetables",
      "subcategory": "fresh",
      "packSize_g": 250,
      "priceZAR": 37.99,
      "per100g": {
        "calories": 22,
        "protein_g": 3.1,
        "carbs_g": 2.3,
        "fat_g": 0.3,
        "fibre_g": 1.0
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "existing",
        "confidence": "medium"
      },
      "notes": "PRICE INCREASED from R27.99 to R37.99. Note: user has mushroom restriction."
    },
    {
      "id": "onions",
      "name": "Onions",
      "woolworthsName": "Brown Onions 1 kg",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-20008215",
      "fatSecretUrl": null,
      "category": "vegetables",
      "subcategory": "fresh",
      "packSize_g": 1000,
      "priceZAR": 22.99,
      "per100g": {
        "calories": 40,
        "protein_g": 1.1,
        "carbs_g": 9.3,
        "fat_g": 0.1,
        "fibre_g": 1.7
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "generic",
        "confidence": "high"
      },
      "notes": "Price unchanged. Essential cooking base."
    },
    {
      "id": "garlic",
      "name": "Garlic",
      "woolworthsName": "Garlic Min 120 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-20150501",
      "fatSecretUrl": null,
      "category": "vegetables",
      "subcategory": "fresh",
      "packSize_g": 120,
      "priceZAR": 48.99,
      "per100g": {
        "calories": 149,
        "protein_g": 6.4,
        "carbs_g": 33.1,
        "fat_g": 0.5,
        "fibre_g": 2.1
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "generic",
        "confidence": "medium"
      },
      "notes": "CHANGED: Was 'per head ~50g R7.99'. Now sold as min 120g pack (2-3 heads) for R48.99. Much more expensive per head."
    },
    {
      "id": "creatine",
      "name": "Creatine Monohydrate",
      "woolworthsName": "Creatine Monohydrate (generic, e.g. USN/NPL) 200g",
      "woolworthsUrl": null,
      "fatSecretUrl": null,
      "category": "condiments-other",
      "subcategory": "supplement",
      "packSize_g": 200,
      "priceZAR": 149.99,
      "per100g": {
        "calories": 0,
        "protein_g": 0,
        "carbs_g": 0,
        "fat_g": 0,
        "fibre_g": 0
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "manual",
        "nutritionSource": "product-label",
        "confidence": "manual"
      },
      "notes": "5g daily dose. Not a Woolworths product — verify price at preferred retailer."
    },
    {
      "id": "low-fat-mayo",
      "name": "Reduced Oil Tangy Mayonnaise",
      "woolworthsName": "Reduced Oil Tangy Mayonnaise 385 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-6008000440813",
      "fatSecretUrl": null,
      "category": "condiments-other",
      "subcategory": "condiment",
      "packSize_g": 385,
      "priceZAR": 50.99,
      "per100g": {
        "calories": 174,
        "protein_g": 0.8,
        "carbs_g": 12.4,
        "fat_g": 13.2,
        "fibre_g": 0.1
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "existing",
        "confidence": "medium"
      },
      "notes": "CHANGED: Was 'Low Fat Mayonnaise 400g R44.99'. Now 'Reduced Oil Tangy Mayonnaise 385g R50.99'. Made with free range whole eggs."
    },
    {
      "id": "soy-sauce",
      "name": "Soy Sauce",
      "woolworthsName": "Kikkoman Tamari Soy Sauce 250ml",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-41390008009",
      "fatSecretUrl": null,
      "category": "condiments-other",
      "subcategory": "condiment",
      "packSize_g": 250,
      "priceZAR": 51.95,
      "per100g": {
        "calories": 53,
        "protein_g": 5.6,
        "carbs_g": 5.6,
        "fat_g": 0.1,
        "fibre_g": 0.4
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "existing",
        "confidence": "medium"
      },
      "notes": "PRICE INCREASED from R32.99 to R51.95. Kikkoman Tamari — Woolworths own brand 250ml not available. Naturally brewed."
    },
    {
      "id": "tomato-paste",
      "name": "Tomato Paste",
      "woolworthsName": "Organic Italian Tomato Paste 200g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-6001009035998",
      "fatSecretUrl": null,
      "category": "condiments-other",
      "subcategory": "condiment",
      "packSize_g": 200,
      "priceZAR": 31.95,
      "per100g": {
        "calories": 82,
        "protein_g": 4.3,
        "carbs_g": 14.1,
        "fat_g": 0.5,
        "fibre_g": 4.1
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "existing",
        "confidence": "medium"
      },
      "notes": "PRICE INCREASED from R19.99 to R31.95. Organic, sun-ripened Italian tomatoes."
    },
    {
      "id": "honey",
      "name": "Pure Honey",
      "woolworthsName": "Pure Honey 375 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-6009189842508",
      "fatSecretUrl": null,
      "category": "condiments-other",
      "subcategory": "sweetener",
      "packSize_g": 375,
      "priceZAR": 49.99,
      "per100g": {
        "calories": 304,
        "protein_g": 0.3,
        "carbs_g": 82.4,
        "fat_g": 0.0,
        "fibre_g": 0.0
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "generic",
        "confidence": "medium"
      },
      "notes": "Used as drizzle on oats. Small macro contribution per 10g serving."
    },
    {
      "id": "rice-cakes",
      "name": "Rice Cakes Plain",
      "woolworthsName": "Rice Cakes 130 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-6009207284996",
      "fatSecretUrl": null,
      "category": "carbs",
      "subcategory": "snack",
      "packSize_g": 130,
      "priceZAR": 19.99,
      "per100g": {
        "calories": 387,
        "protein_g": 7.8,
        "carbs_g": 81.5,
        "fat_g": 2.8,
        "fibre_g": 3.5
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "generic",
        "confidence": "medium"
      },
      "notes": "Plain puffed rice cakes. ~9g per cake. Used as snack alongside shakes."
    },
    {
      "id": "low-fat-milk",
      "name": "Low Fat Milk",
      "woolworthsName": "Ayrshire Low Fat Milk 2 L",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-20126356",
      "fatSecretUrl": null,
      "category": "protein",
      "subcategory": "dairy",
      "packSize_g": 2000,
      "priceZAR": 42.99,
      "per100g": {
        "calories": 42,
        "protein_g": 3.4,
        "carbs_g": 4.9,
        "fat_g": 1.5,
        "fibre_g": 0.0
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "generic",
        "confidence": "medium"
      },
      "notes": "Standard low fat milk. Used in cereal and sauces."
    },
    {
      "id": "napolitana-sauce",
      "name": "Napolitana Pasta Sauce",
      "woolworthsName": "Napolitana Pasta Sauce 400 g",
      "woolworthsUrl": "https://www.woolworths.co.za/prod/_/A-6001009028488",
      "fatSecretUrl": null,
      "category": "condiments-other",
      "subcategory": "sauce",
      "packSize_g": 400,
      "priceZAR": 34.99,
      "per100g": {
        "calories": 50,
        "protein_g": 1.5,
        "carbs_g": 7.0,
        "fat_g": 1.5,
        "fibre_g": 1.5
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "estimated",
        "confidence": "medium"
      },
      "notes": "Woolworths napolitana pasta sauce. Used in bolognese meals. Check packaging for exact macros."
    },
    {
      "id": "chicken-veg-ready-meal",
      "name": "Chicken & Veg Ready Meal",
      "woolworthsName": "Chicken & Vegetable Ready Meal 350 g",
      "woolworthsUrl": null,
      "fatSecretUrl": null,
      "category": "protein",
      "subcategory": "ready-meal",
      "packSize_g": 350,
      "priceZAR": 54.99,
      "per100g": {
        "calories": 130,
        "protein_g": 10.0,
        "carbs_g": 10.0,
        "fat_g": 5.0,
        "fibre_g": 2.0
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "estimated",
        "confidence": "low"
      },
      "notes": "Estimated macros — check packaging in-store. Chicken with vegetables ready meal."
    },
    {
      "id": "chicken-rice-ready-meal",
      "name": "Chicken & Rice Ready Meal",
      "woolworthsName": "Chicken & Rice Ready Meal 350 g",
      "woolworthsUrl": null,
      "fatSecretUrl": null,
      "category": "protein",
      "subcategory": "ready-meal",
      "packSize_g": 350,
      "priceZAR": 54.99,
      "per100g": {
        "calories": 140,
        "protein_g": 10.0,
        "carbs_g": 15.0,
        "fat_g": 4.0,
        "fibre_g": 1.0
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "estimated",
        "confidence": "low"
      },
      "notes": "Estimated macros — check packaging in-store. Chicken with rice ready meal."
    },
    {
      "id": "hake-fillets",
      "name": "Hake Fillets",
      "woolworthsName": "Hake Fillets 400 g",
      "woolworthsUrl": null,
      "fatSecretUrl": null,
      "category": "protein",
      "subcategory": "fish",
      "packSize_g": 400,
      "priceZAR": 64.99,
      "per100g": {
        "calories": 71,
        "protein_g": 14.5,
        "carbs_g": 0.1,
        "fat_g": 1.4,
        "fibre_g": 0.3
      },
      "verified": {
        "date": "2026-02-22",
        "priceSource": "woolworths.co.za",
        "nutritionSource": "estimated",
        "confidence": "medium"
      },
      "notes": "Using same nutritional values as hake medallions. Plan references hake fillets specifically."
    }
  ]
};

// === BUILD: Embedded plan data ===
const __PLAN__ = {
  "planId": "plan-001",
  "startDate": "2026-02-22",
  "endDate": "2026-03-08",
  "dailyTargets": {
    "calories": 2300,
    "protein_g": 200,
    "carbs_g": 218,
    "fat_g": 70
  },
  "supplements": ["Whey Protein Isolate", "Creatine Monohydrate 5g daily (add to post-workout shake or water)"],
  "notes": "All products sourced from Woolworths South Africa. No broccoli, mushrooms, cilantro, or raw vegetables. Batch prep on Feb 22 (Sunday) before plan starts. Two shopping trips: Feb 22 and Mar 1. Prep days are Feb 22 (pre-plan) and Day 7 (Sunday Mar 1). UPDATED: Quantities adjusted to hit daily macro targets (2300cal/200P/218C/70F) based on engine-computed values.",
  "days": [
    {
      "day": 0,
      "dayOfWeek": "Sunday",
      "date": "2026-02-22",
      "prepDay": true,
      "batchPrepInstructions": "Batch cook: 1.8kg chicken breast (season with paprika, garlic, salt — grill or bake at 200C, 25 min). Cook 800g dry rice. Boil 18 eggs. Brown 800g lean mince with onion and garlic. Roast 600g butternut cubes. Bake 4 sweet potatoes (200C, 45 min). Store everything in portioned containers for the week.",
      "meals": []
    },
    {
      "day": 1,
      "dayOfWeek": "Monday",
      "date": "2026-02-23",
      "prepDay": false,
      "meals": [
        {
          "slot": "breakfast",
          "time": "07:00",
          "name": "Oats with Whey, Peanut Butter & Banana",
          "ingredients": [
            { "productId": "rolled-oats", "quantity_g": 50, "state": "raw", "notes": "raw" },
            { "productId": "whey-protein", "quantity_g": 30, "state": "raw", "notes": "1 scoop" },
            { "productId": "peanut-butter", "quantity_g": 20, "state": "raw", "notes": "smooth" },
            { "productId": "bananas", "quantity_g": 100, "state": "raw", "notes": "1 small, sliced" }
          ],
          "prep": "Cook oats with water in microwave 3 min. Stir in whey protein. Top with sliced banana and peanut butter.",
          "batchPrep": false
        },
        {
          "slot": "lunch",
          "time": "12:30",
          "name": "Lean Beef Mince Bolognese with Pasta",
          "ingredients": [
            { "productId": "lean-beef-mince", "quantity_g": 120, "state": "cooked", "notes": "from batch cook" },
            { "productId": "penne-pasta", "quantity_g": 110, "state": "cooked", "notes": "penne or fusilli" },
            { "productId": "napolitana-sauce", "quantity_g": 80, "state": "raw", "notes": "Woolworths napolitana" },
            { "productId": "cheddar-cheese", "quantity_g": 15, "state": "raw", "notes": "grated on top" }
          ],
          "prep": "Reheat batch-cooked mince with pasta sauce. Cook pasta fresh or reheat. Combine. Top with cheese.",
          "batchPrep": true
        },
        {
          "slot": "pre-workout",
          "time": "17:00",
          "name": "Chicken Breast with Rice, Mixed Veg & Cheese",
          "ingredients": [
            { "productId": "chicken-breast", "quantity_g": 120, "state": "cooked", "notes": "from batch cook" },
            { "productId": "white-basmati-rice", "quantity_g": 130, "state": "cooked", "notes": "from batch cook" },
            { "productId": "frozen-mixed-veg", "quantity_g": 100, "state": "raw", "notes": "microwave steamed 3 min" },
            { "productId": "cheddar-cheese", "quantity_g": 15, "state": "raw", "notes": "grated on top" }
          ],
          "prep": "Reheat chicken and rice. Microwave steam mixed veg for 3 min. Top with grated cheese.",
          "batchPrep": true
        },
        {
          "slot": "post-workout",
          "time": "20:30",
          "name": "Whey Shake with Banana & Oats",
          "ingredients": [
            { "productId": "whey-protein", "quantity_g": 30, "state": "raw", "notes": "1 scoop" },
            { "productId": "bananas", "quantity_g": 100, "state": "raw", "notes": "1 small" },
            { "productId": "rolled-oats", "quantity_g": 35, "state": "raw", "notes": "raw, blended into shake" },
            { "productId": "peanut-butter", "quantity_g": 15, "state": "raw", "notes": "blended in" }
          ],
          "prep": "Blend whey, oats, banana, peanut butter, and water. Add creatine 5g.",
          "batchPrep": false
        },
        {
          "slot": "pre-bed",
          "time": "23:00",
          "name": "Fat Free Yoghurt with Whey & Nuts",
          "ingredients": [
            { "productId": "fat-free-yoghurt", "quantity_g": 200, "state": "raw", "notes": "Woolworths plain" },
            { "productId": "whey-protein", "quantity_g": 30, "state": "raw", "notes": "1 scoop" },
            { "productId": "mixed-nuts", "quantity_g": 20, "state": "raw", "notes": "unsalted" }
          ],
          "prep": "Mix whey into yoghurt. Top with nuts.",
          "batchPrep": false
        }
      ]
    },
    {
      "day": 2,
      "dayOfWeek": "Tuesday",
      "date": "2026-02-24",
      "prepDay": false,
      "meals": [
        {
          "slot": "breakfast",
          "time": "07:00",
          "name": "Egg White Omelette with Toast",
          "ingredients": [
            { "productId": "liquid-egg-whites", "quantity_g": 200, "state": "raw", "notes": "200ml" },
            { "productId": "free-range-eggs", "quantity_g": 100, "state": "raw", "notes": "2 whole eggs" },
            { "productId": "wholewheat-bread", "quantity_g": 75, "state": "raw", "notes": "2.5 slices" },
            { "productId": "cheddar-cheese", "quantity_g": 20, "state": "raw", "notes": "grated, in omelette" }
          ],
          "prep": "Whisk egg whites and whole eggs. Cook in non-stick pan with spray oil. Add cheese before folding. Serve with toast.",
          "batchPrep": false
        },
        {
          "slot": "lunch",
          "time": "12:30",
          "name": "Chicken & Rice with Creamy Spinach",
          "ingredients": [
            { "productId": "chicken-breast", "quantity_g": 100, "state": "cooked", "notes": "from batch cook" },
            { "productId": "white-basmati-rice", "quantity_g": 200, "state": "cooked", "notes": "from batch cook" },
            { "productId": "frozen-spinach", "quantity_g": 100, "state": "raw", "notes": "thawed, squeezed dry" },
            { "productId": "low-fat-milk", "quantity_g": 50, "state": "raw", "notes": "for sauce" },
            { "productId": "cheddar-cheese", "quantity_g": 15, "state": "raw", "notes": "grated into spinach sauce" }
          ],
          "prep": "Cook frozen spinach in microwave. Squeeze out excess water. Heat in pan with spray oil, add milk and cheese, season with garlic salt. Serve over reheated chicken and rice.",
          "batchPrep": true
        },
        {
          "slot": "pre-workout",
          "time": "17:00",
          "name": "Lean Mince with Sweet Potato",
          "ingredients": [
            { "productId": "lean-beef-mince", "quantity_g": 120, "state": "cooked", "notes": "from batch cook" },
            { "productId": "sweet-potatoes", "quantity_g": 200, "state": "cooked", "notes": "from batch bake" }
          ],
          "prep": "Reheat batch-baked sweet potato and mince in microwave.",
          "batchPrep": true
        },
        {
          "slot": "post-workout",
          "time": "20:30",
          "name": "Chicken Breast with Rice",
          "ingredients": [
            { "productId": "chicken-breast", "quantity_g": 100, "state": "cooked", "notes": "from batch cook" },
            { "productId": "white-basmati-rice", "quantity_g": 200, "state": "cooked", "notes": "from batch cook" },
            { "productId": "soy-sauce", "quantity_g": 10, "state": "raw", "notes": "for flavour" }
          ],
          "prep": "Reheat chicken and rice. Drizzle with soy sauce.",
          "batchPrep": true
        },
        {
          "slot": "pre-bed",
          "time": "23:00",
          "name": "Cottage Cheese with Mixed Nuts & Peanut Butter",
          "ingredients": [
            { "productId": "cottage-cheese-fat-free", "quantity_g": 200, "state": "raw", "notes": "smooth or chunky" },
            { "productId": "mixed-nuts", "quantity_g": 30, "state": "raw", "notes": "unsalted" },
            { "productId": "peanut-butter", "quantity_g": 15, "state": "raw", "notes": "stirred in" }
          ],
          "prep": "Serve cottage cheese in bowl, stir in peanut butter, top with nuts.",
          "batchPrep": false
        }
      ]
    },
    {
      "day": 3,
      "dayOfWeek": "Wednesday",
      "date": "2026-02-25",
      "prepDay": false,
      "meals": [
        {
          "slot": "breakfast",
          "time": "07:00",
          "name": "Futurelife Cereal with Milk & Boiled Eggs",
          "ingredients": [
            { "productId": "futurelife-cereal", "quantity_g": 50, "state": "raw", "notes": "1 serving" },
            { "productId": "low-fat-milk", "quantity_g": 200, "state": "raw", "notes": "200ml" },
            { "productId": "free-range-eggs", "quantity_g": 150, "state": "raw", "notes": "3 eggs, from batch" }
          ],
          "prep": "Pour cereal into bowl, add milk. Peel 3 batch-boiled eggs and eat on the side.",
          "batchPrep": true
        },
        {
          "slot": "lunch",
          "time": "12:30",
          "name": "Hake Fillet with Sweet Potato & Spinach",
          "ingredients": [
            { "productId": "hake-fillets", "quantity_g": 250, "state": "raw", "notes": "2 fillets" },
            { "productId": "sweet-potatoes", "quantity_g": 200, "state": "cooked", "notes": "from batch bake" },
            { "productId": "frozen-spinach", "quantity_g": 100, "state": "raw", "notes": "microwave steamed 3 min" }
          ],
          "prep": "Bake hake fillets at 200C for 15 min the evening before. Store in container with sweet potato and spinach. Reheat in microwave at office.",
          "batchPrep": false
        },
        {
          "slot": "pre-workout",
          "time": "17:00",
          "name": "Whey Shake with Banana, Oats & Rice Cakes",
          "ingredients": [
            { "productId": "whey-protein", "quantity_g": 30, "state": "raw", "notes": "1 scoop" },
            { "productId": "bananas", "quantity_g": 120, "state": "raw", "notes": "1 medium" },
            { "productId": "rolled-oats", "quantity_g": 40, "state": "raw", "notes": "raw, blended" },
            { "productId": "rice-cakes", "quantity_g": 18, "state": "raw", "notes": "2 cakes" },
            { "productId": "peanut-butter", "quantity_g": 15, "state": "raw", "notes": "on rice cakes" }
          ],
          "prep": "Blend whey, oats, banana, and water. Spread peanut butter on rice cakes and eat on the side.",
          "batchPrep": false
        },
        {
          "slot": "post-workout",
          "time": "20:30",
          "name": "Lean Mince Pasta with Tomato Sauce",
          "ingredients": [
            { "productId": "lean-beef-mince", "quantity_g": 130, "state": "cooked", "notes": "from batch cook" },
            { "productId": "penne-pasta", "quantity_g": 120, "state": "cooked", "notes": "penne" },
            { "productId": "napolitana-sauce", "quantity_g": 80, "state": "raw", "notes": "Woolworths napolitana" }
          ],
          "prep": "Cook pasta. Reheat mince with sauce. Combine.",
          "batchPrep": true
        },
        {
          "slot": "pre-bed",
          "time": "23:00",
          "name": "Cottage Cheese with Biltong & Nuts",
          "ingredients": [
            { "productId": "cottage-cheese-fat-free", "quantity_g": 200, "state": "raw", "notes": "smooth or chunky" },
            { "productId": "beef-biltong", "quantity_g": 40, "state": "raw", "notes": "sliced" },
            { "productId": "mixed-nuts", "quantity_g": 20, "state": "raw", "notes": "unsalted" }
          ],
          "prep": "Serve cottage cheese in bowl with biltong slices and nuts on top.",
          "batchPrep": false
        }
      ]
    },
    {
      "day": 4,
      "dayOfWeek": "Thursday",
      "date": "2026-02-26",
      "prepDay": false,
      "meals": [
        {
          "slot": "breakfast",
          "time": "07:00",
          "name": "Cottage Cheese Oats with Nuts",
          "ingredients": [
            { "productId": "cottage-cheese-fat-free", "quantity_g": 150, "state": "raw", "notes": "smooth" },
            { "productId": "rolled-oats", "quantity_g": 50, "state": "raw", "notes": "raw, cooked with water" },
            { "productId": "mixed-nuts", "quantity_g": 30, "state": "raw", "notes": "unsalted, chopped" },
            { "productId": "honey", "quantity_g": 15, "state": "raw", "notes": "drizzle" }
          ],
          "prep": "Cook oats with water. Stir in cottage cheese. Top with nuts and honey drizzle.",
          "batchPrep": false
        },
        {
          "slot": "lunch",
          "time": "12:30",
          "name": "Grilled Chicken Breast with Rice, Butternut & Cheese",
          "ingredients": [
            { "productId": "chicken-breast", "quantity_g": 120, "state": "cooked", "notes": "from batch cook" },
            { "productId": "white-basmati-rice", "quantity_g": 140, "state": "cooked", "notes": "from batch cook" },
            { "productId": "frozen-butternut", "quantity_g": 120, "state": "cooked", "notes": "from batch cook" },
            { "productId": "cheddar-cheese", "quantity_g": 15, "state": "raw", "notes": "grated on top" }
          ],
          "prep": "Reheat batch-cooked chicken, rice, and butternut. Top with grated cheese.",
          "batchPrep": true
        },
        {
          "slot": "pre-workout",
          "time": "17:00",
          "name": "Basa Fillet with Rice",
          "ingredients": [
            { "productId": "basa-fillets", "quantity_g": 200, "state": "raw", "notes": "2 fillets" },
            { "productId": "white-basmati-rice", "quantity_g": 150, "state": "cooked", "notes": "from batch cook" },
            { "productId": "soy-sauce", "quantity_g": 10, "state": "raw", "notes": "for flavour" }
          ],
          "prep": "Bake basa fillets at 200C for 12 min the evening before. Store in container with rice. Reheat in microwave at office.",
          "batchPrep": false
        },
        {
          "slot": "post-workout",
          "time": "20:30",
          "name": "Whey Shake with Banana & Oats",
          "ingredients": [
            { "productId": "whey-protein", "quantity_g": 30, "state": "raw", "notes": "1 scoop" },
            { "productId": "bananas", "quantity_g": 120, "state": "raw", "notes": "1 medium" },
            { "productId": "rolled-oats", "quantity_g": 50, "state": "raw", "notes": "raw, blended" },
            { "productId": "peanut-butter", "quantity_g": 20, "state": "raw", "notes": "blended in" }
          ],
          "prep": "Blend whey, oats, banana, peanut butter, and water. Add creatine 5g.",
          "batchPrep": false
        },
        {
          "slot": "pre-bed",
          "time": "23:00",
          "name": "Biltong with Cottage Cheese & Nuts",
          "ingredients": [
            { "productId": "beef-biltong", "quantity_g": 40, "state": "raw", "notes": "sliced" },
            { "productId": "cottage-cheese-fat-free", "quantity_g": 150, "state": "raw", "notes": "smooth" },
            { "productId": "mixed-nuts", "quantity_g": 25, "state": "raw", "notes": "unsalted" }
          ],
          "prep": "Serve biltong and cottage cheese on the side with nuts.",
          "batchPrep": false
        }
      ]
    },
    {
      "day": 5,
      "dayOfWeek": "Friday",
      "date": "2026-02-27",
      "prepDay": false,
      "meals": [
        {
          "slot": "breakfast",
          "time": "07:00",
          "name": "Scrambled Eggs with Toast & Banana",
          "ingredients": [
            { "productId": "free-range-eggs", "quantity_g": 150, "state": "raw", "notes": "3 eggs" },
            { "productId": "wholewheat-bread", "quantity_g": 60, "state": "raw", "notes": "2 slices" },
            { "productId": "bananas", "quantity_g": 100, "state": "raw", "notes": "1 small" },
            { "productId": "cheddar-cheese", "quantity_g": 15, "state": "raw", "notes": "on eggs" }
          ],
          "prep": "Scramble 3 eggs with cheese. Toast bread. Banana on the side.",
          "batchPrep": false
        },
        {
          "slot": "lunch",
          "time": "12:30",
          "name": "Lean Beef Mince Bolognese with Pasta & Cheese",
          "ingredients": [
            { "productId": "lean-beef-mince", "quantity_g": 120, "state": "cooked", "notes": "from batch cook" },
            { "productId": "penne-pasta", "quantity_g": 120, "state": "cooked", "notes": "penne" },
            { "productId": "napolitana-sauce", "quantity_g": 80, "state": "raw", "notes": "Woolworths napolitana" },
            { "productId": "cheddar-cheese", "quantity_g": 15, "state": "raw", "notes": "grated on top" }
          ],
          "prep": "Reheat mince with sauce. Cook or reheat pasta. Combine. Top with cheese.",
          "batchPrep": true
        },
        {
          "slot": "pre-workout",
          "time": "17:00",
          "name": "Chicken Breast with Rice, Mixed Veg & Cheese",
          "ingredients": [
            { "productId": "chicken-breast", "quantity_g": 110, "state": "cooked", "notes": "from batch cook" },
            { "productId": "white-basmati-rice", "quantity_g": 150, "state": "cooked", "notes": "from batch cook" },
            { "productId": "frozen-mixed-veg", "quantity_g": 100, "state": "raw", "notes": "microwave steamed 3 min" },
            { "productId": "cheddar-cheese", "quantity_g": 15, "state": "raw", "notes": "grated on top" }
          ],
          "prep": "Reheat chicken and rice. Microwave steam mixed veg for 3 min. Top with grated cheese.",
          "batchPrep": true
        },
        {
          "slot": "post-workout",
          "time": "20:30",
          "name": "Chicken Breast with Rice & Cheese",
          "ingredients": [
            { "productId": "chicken-breast", "quantity_g": 110, "state": "cooked", "notes": "from batch cook" },
            { "productId": "white-basmati-rice", "quantity_g": 150, "state": "cooked", "notes": "from batch cook" },
            { "productId": "soy-sauce", "quantity_g": 10, "state": "raw", "notes": "for flavour" },
            { "productId": "cheddar-cheese", "quantity_g": 15, "state": "raw", "notes": "grated on top" }
          ],
          "prep": "Reheat chicken and rice. Season with soy sauce. Top with grated cheese.",
          "batchPrep": true
        },
        {
          "slot": "pre-bed",
          "time": "23:00",
          "name": "Fat Free Yoghurt with Whey & Nuts",
          "ingredients": [
            { "productId": "fat-free-yoghurt", "quantity_g": 200, "state": "raw", "notes": "Woolworths plain" },
            { "productId": "whey-protein", "quantity_g": 30, "state": "raw", "notes": "1 scoop" },
            { "productId": "mixed-nuts", "quantity_g": 25, "state": "raw", "notes": "unsalted" }
          ],
          "prep": "Mix whey into yoghurt. Top with nuts.",
          "batchPrep": false
        }
      ]
    },
    {
      "day": 6,
      "dayOfWeek": "Saturday",
      "date": "2026-02-28",
      "prepDay": false,
      "meals": [
        {
          "slot": "breakfast",
          "time": "08:30",
          "name": "Oats with Whey, Peanut Butter & Banana",
          "ingredients": [
            { "productId": "rolled-oats", "quantity_g": 50, "state": "raw", "notes": "raw" },
            { "productId": "whey-protein", "quantity_g": 30, "state": "raw", "notes": "1 scoop" },
            { "productId": "peanut-butter", "quantity_g": 15, "state": "raw", "notes": "smooth" },
            { "productId": "bananas", "quantity_g": 100, "state": "raw", "notes": "1 small, sliced" }
          ],
          "prep": "Cook oats with water. Stir in whey. Top with banana and peanut butter.",
          "batchPrep": false
        },
        {
          "slot": "lunch",
          "time": "12:30",
          "name": "Woolworths Chicken Ready Meal with Extra Protein",
          "ingredients": [
            { "productId": "chicken-veg-ready-meal", "quantity_g": 350, "state": "raw", "notes": "1 tray" },
            { "productId": "free-range-eggs", "quantity_g": 100, "state": "raw", "notes": "2 eggs, from batch" }
          ],
          "prep": "Microwave ready meal per instructions. Eat 2 boiled eggs on the side.",
          "batchPrep": false
        },
        {
          "slot": "pre-workout",
          "time": "17:00",
          "name": "Lean Mince with Sweet Potato",
          "ingredients": [
            { "productId": "lean-beef-mince", "quantity_g": 120, "state": "cooked", "notes": "from batch cook (last portions)" },
            { "productId": "sweet-potatoes", "quantity_g": 200, "state": "cooked", "notes": "microwave baked" }
          ],
          "prep": "Microwave sweet potato. Reheat last of batch-cooked mince.",
          "batchPrep": true
        },
        {
          "slot": "post-workout",
          "time": "20:30",
          "name": "Whey Shake with Banana & Oats",
          "ingredients": [
            { "productId": "whey-protein", "quantity_g": 30, "state": "raw", "notes": "1 scoop" },
            { "productId": "bananas", "quantity_g": 120, "state": "raw", "notes": "1 medium" },
            { "productId": "rolled-oats", "quantity_g": 40, "state": "raw", "notes": "raw, blended" }
          ],
          "prep": "Blend whey, oats, banana, and water. Add creatine 5g.",
          "batchPrep": false
        },
        {
          "slot": "pre-bed",
          "time": "23:00",
          "name": "Cottage Cheese with Whey & Nuts",
          "ingredients": [
            { "productId": "cottage-cheese-fat-free", "quantity_g": 200, "state": "raw", "notes": "smooth or chunky" },
            { "productId": "whey-protein", "quantity_g": 30, "state": "raw", "notes": "1 scoop, stirred in" },
            { "productId": "mixed-nuts", "quantity_g": 15, "state": "raw", "notes": "unsalted" }
          ],
          "prep": "Mix whey into cottage cheese. Top with nuts.",
          "batchPrep": false
        }
      ]
    },
    {
      "day": 7,
      "dayOfWeek": "Sunday",
      "date": "2026-03-01",
      "prepDay": true,
      "batchPrepInstructions": "Week 2 batch cook: 1.8kg chicken breast (season with lemon pepper, garlic, salt — grill or bake at 200C, 25 min). Cook 800g dry rice. Boil 18 eggs. Brown 800g lean mince with onion and garlic. Roast 600g butternut cubes. Bake 4 sweet potatoes (200C, 45 min). Store everything in portioned containers for the week.",
      "meals": [
        {
          "slot": "breakfast",
          "time": "08:30",
          "name": "Egg White Omelette with Toast",
          "ingredients": [
            { "productId": "liquid-egg-whites", "quantity_g": 150, "state": "raw", "notes": "150ml" },
            { "productId": "free-range-eggs", "quantity_g": 100, "state": "raw", "notes": "2 whole eggs" },
            { "productId": "wholewheat-bread", "quantity_g": 60, "state": "raw", "notes": "2 slices" },
            { "productId": "cheddar-cheese", "quantity_g": 20, "state": "raw", "notes": "grated, in omelette" },
            { "productId": "peanut-butter", "quantity_g": 15, "state": "raw", "notes": "on toast" }
          ],
          "prep": "Whisk egg whites and whole eggs. Cook omelette, add cheese. Serve with toast spread with peanut butter.",
          "batchPrep": false
        },
        {
          "slot": "lunch",
          "time": "12:30",
          "name": "Grilled Chicken Breast with Rice, Butternut & Cheese",
          "ingredients": [
            { "productId": "chicken-breast", "quantity_g": 120, "state": "cooked", "notes": "from batch cook" },
            { "productId": "white-basmati-rice", "quantity_g": 150, "state": "cooked", "notes": "from batch cook" },
            { "productId": "frozen-butternut", "quantity_g": 120, "state": "cooked", "notes": "from batch cook" },
            { "productId": "cheddar-cheese", "quantity_g": 15, "state": "raw", "notes": "grated on top" }
          ],
          "prep": "Reheat batch-cooked chicken, rice, and butternut. Top with grated cheese.",
          "batchPrep": true
        },
        {
          "slot": "pre-workout",
          "time": "17:00",
          "name": "Chicken Breast with Rice, Mixed Veg & Cheese",
          "ingredients": [
            { "productId": "chicken-breast", "quantity_g": 110, "state": "cooked", "notes": "from batch cook" },
            { "productId": "white-basmati-rice", "quantity_g": 150, "state": "cooked", "notes": "from batch cook" },
            { "productId": "frozen-mixed-veg", "quantity_g": 100, "state": "raw", "notes": "microwave steamed 3 min" },
            { "productId": "cheddar-cheese", "quantity_g": 15, "state": "raw", "notes": "grated on top" }
          ],
          "prep": "Reheat chicken and rice. Microwave steam mixed veg for 3 min. Top with grated cheese.",
          "batchPrep": true
        },
        {
          "slot": "post-workout",
          "time": "20:30",
          "name": "Whey Shake with Banana & Oats",
          "ingredients": [
            { "productId": "whey-protein", "quantity_g": 30, "state": "raw", "notes": "1 scoop" },
            { "productId": "bananas", "quantity_g": 120, "state": "raw", "notes": "1 medium" },
            { "productId": "rolled-oats", "quantity_g": 40, "state": "raw", "notes": "raw, blended" },
            { "productId": "peanut-butter", "quantity_g": 20, "state": "raw", "notes": "blended in" }
          ],
          "prep": "Blend whey, oats, banana, peanut butter, and water. Add creatine 5g.",
          "batchPrep": false
        },
        {
          "slot": "pre-bed",
          "time": "23:00",
          "name": "Cottage Cheese with Mixed Nuts",
          "ingredients": [
            { "productId": "cottage-cheese-fat-free", "quantity_g": 200, "state": "raw", "notes": "smooth or chunky" },
            { "productId": "mixed-nuts", "quantity_g": 25, "state": "raw", "notes": "unsalted" }
          ],
          "prep": "Serve cottage cheese in bowl, top with nuts.",
          "batchPrep": false
        }
      ]
    },
    {
      "day": 8,
      "dayOfWeek": "Monday",
      "date": "2026-03-02",
      "prepDay": false,
      "meals": [
        {
          "slot": "breakfast",
          "time": "07:00",
          "name": "Oats with Whey, Peanut Butter & Banana",
          "ingredients": [
            { "productId": "rolled-oats", "quantity_g": 50, "state": "raw", "notes": "raw" },
            { "productId": "whey-protein", "quantity_g": 30, "state": "raw", "notes": "1 scoop" },
            { "productId": "peanut-butter", "quantity_g": 25, "state": "raw", "notes": "smooth" },
            { "productId": "bananas", "quantity_g": 100, "state": "raw", "notes": "1 small, sliced" }
          ],
          "prep": "Cook oats with water in microwave. Stir in whey. Top with banana and peanut butter.",
          "batchPrep": false
        },
        {
          "slot": "lunch",
          "time": "12:30",
          "name": "Chicken & Rice with Creamy Spinach",
          "ingredients": [
            { "productId": "chicken-breast", "quantity_g": 100, "state": "cooked", "notes": "from batch cook" },
            { "productId": "white-basmati-rice", "quantity_g": 160, "state": "cooked", "notes": "from batch cook" },
            { "productId": "frozen-spinach", "quantity_g": 100, "state": "raw", "notes": "thawed, squeezed dry" },
            { "productId": "low-fat-milk", "quantity_g": 50, "state": "raw", "notes": "for sauce" },
            { "productId": "cheddar-cheese", "quantity_g": 15, "state": "raw", "notes": "grated into spinach sauce" }
          ],
          "prep": "Cook frozen spinach in microwave. Squeeze out excess water. Heat in pan with spray oil, add milk and cheese, season with garlic salt. Serve over reheated chicken and rice.",
          "batchPrep": true
        },
        {
          "slot": "pre-workout",
          "time": "17:00",
          "name": "Lean Mince with Sweet Potato & Cheese",
          "ingredients": [
            { "productId": "lean-beef-mince", "quantity_g": 120, "state": "cooked", "notes": "from batch cook" },
            { "productId": "sweet-potatoes", "quantity_g": 200, "state": "cooked", "notes": "from batch bake" },
            { "productId": "cheddar-cheese", "quantity_g": 15, "state": "raw", "notes": "grated on top" }
          ],
          "prep": "Reheat batch-baked sweet potato and mince in microwave. Top with grated cheese.",
          "batchPrep": true
        },
        {
          "slot": "post-workout",
          "time": "20:30",
          "name": "Chicken Breast with Rice & Cheese",
          "ingredients": [
            { "productId": "chicken-breast", "quantity_g": 100, "state": "cooked", "notes": "from batch cook" },
            { "productId": "white-basmati-rice", "quantity_g": 170, "state": "cooked", "notes": "from batch cook" },
            { "productId": "soy-sauce", "quantity_g": 10, "state": "raw", "notes": "for flavour" },
            { "productId": "cheddar-cheese", "quantity_g": 15, "state": "raw", "notes": "grated on top" }
          ],
          "prep": "Reheat chicken and rice. Season with soy sauce. Top with grated cheese.",
          "batchPrep": true
        },
        {
          "slot": "pre-bed",
          "time": "23:00",
          "name": "Biltong with Cottage Cheese & Nuts",
          "ingredients": [
            { "productId": "beef-biltong", "quantity_g": 40, "state": "raw", "notes": "sliced" },
            { "productId": "cottage-cheese-fat-free", "quantity_g": 150, "state": "raw", "notes": "smooth" },
            { "productId": "mixed-nuts", "quantity_g": 20, "state": "raw", "notes": "unsalted" }
          ],
          "prep": "Serve biltong with cottage cheese and nuts.",
          "batchPrep": false
        }
      ]
    },
    {
      "day": 9,
      "dayOfWeek": "Tuesday",
      "date": "2026-03-03",
      "prepDay": false,
      "meals": [
        {
          "slot": "breakfast",
          "time": "07:00",
          "name": "Futurelife Cereal with Milk & Boiled Eggs",
          "ingredients": [
            { "productId": "futurelife-cereal", "quantity_g": 50, "state": "raw", "notes": "1 serving" },
            { "productId": "low-fat-milk", "quantity_g": 200, "state": "raw", "notes": "200ml" },
            { "productId": "free-range-eggs", "quantity_g": 100, "state": "raw", "notes": "2 eggs, from batch" },
            { "productId": "peanut-butter", "quantity_g": 15, "state": "raw", "notes": "on the side" }
          ],
          "prep": "Pour cereal, add milk. Eat 2 batch-boiled eggs on the side. Have peanut butter on a spoon.",
          "batchPrep": true
        },
        {
          "slot": "lunch",
          "time": "12:30",
          "name": "Hake Fillet with Sweet Potato & Spinach",
          "ingredients": [
            { "productId": "hake-fillets", "quantity_g": 250, "state": "raw", "notes": "2 fillets" },
            { "productId": "sweet-potatoes", "quantity_g": 200, "state": "cooked", "notes": "from batch bake" },
            { "productId": "frozen-spinach", "quantity_g": 100, "state": "raw", "notes": "microwave steamed 3 min" }
          ],
          "prep": "Bake hake fillets at 200C for 15 min the evening before. Store in container with sweet potato and spinach. Reheat in microwave at office.",
          "batchPrep": false
        },
        {
          "slot": "pre-workout",
          "time": "17:00",
          "name": "Chicken Breast with Rice & Mixed Veg",
          "ingredients": [
            { "productId": "chicken-breast", "quantity_g": 115, "state": "cooked", "notes": "from batch cook" },
            { "productId": "white-basmati-rice", "quantity_g": 150, "state": "cooked", "notes": "from batch cook" },
            { "productId": "frozen-mixed-veg", "quantity_g": 100, "state": "raw", "notes": "microwave steamed 3 min" }
          ],
          "prep": "Reheat chicken and rice. Microwave steam mixed veg for 3 min.",
          "batchPrep": true
        },
        {
          "slot": "post-workout",
          "time": "20:30",
          "name": "Lean Mince Pasta with Tomato Sauce",
          "ingredients": [
            { "productId": "lean-beef-mince", "quantity_g": 120, "state": "cooked", "notes": "from batch cook" },
            { "productId": "penne-pasta", "quantity_g": 120, "state": "cooked", "notes": "penne" },
            { "productId": "napolitana-sauce", "quantity_g": 80, "state": "raw", "notes": "Woolworths napolitana" },
            { "productId": "cheddar-cheese", "quantity_g": 15, "state": "raw", "notes": "grated on top" }
          ],
          "prep": "Cook pasta. Reheat mince with sauce. Combine. Top with grated cheese.",
          "batchPrep": true
        },
        {
          "slot": "pre-bed",
          "time": "23:00",
          "name": "Fat Free Yoghurt with Whey & Nuts",
          "ingredients": [
            { "productId": "fat-free-yoghurt", "quantity_g": 200, "state": "raw", "notes": "Woolworths plain" },
            { "productId": "whey-protein", "quantity_g": 30, "state": "raw", "notes": "1 scoop" },
            { "productId": "mixed-nuts", "quantity_g": 30, "state": "raw", "notes": "unsalted" }
          ],
          "prep": "Mix whey into yoghurt. Top with nuts.",
          "batchPrep": false
        }
      ]
    },
    {
      "day": 10,
      "dayOfWeek": "Wednesday",
      "date": "2026-03-04",
      "prepDay": false,
      "meals": [
        {
          "slot": "breakfast",
          "time": "07:00",
          "name": "Scrambled Eggs with Toast & Banana",
          "ingredients": [
            { "productId": "free-range-eggs", "quantity_g": 150, "state": "raw", "notes": "3 eggs" },
            { "productId": "wholewheat-bread", "quantity_g": 60, "state": "raw", "notes": "2 slices" },
            { "productId": "bananas", "quantity_g": 100, "state": "raw", "notes": "1 small" },
            { "productId": "cheddar-cheese", "quantity_g": 15, "state": "raw", "notes": "on eggs" }
          ],
          "prep": "Scramble 3 eggs with cheese. Toast bread. Banana on the side.",
          "batchPrep": false
        },
        {
          "slot": "lunch",
          "time": "12:30",
          "name": "Lean Beef Mince Bolognese with Pasta",
          "ingredients": [
            { "productId": "lean-beef-mince", "quantity_g": 150, "state": "cooked", "notes": "from batch cook" },
            { "productId": "penne-pasta", "quantity_g": 110, "state": "cooked", "notes": "penne" },
            { "productId": "napolitana-sauce", "quantity_g": 80, "state": "raw", "notes": "Woolworths napolitana" }
          ],
          "prep": "Reheat mince with sauce. Cook or reheat pasta. Combine.",
          "batchPrep": true
        },
        {
          "slot": "pre-workout",
          "time": "17:00",
          "name": "Whey Shake with Banana, Oats & Rice Cakes",
          "ingredients": [
            { "productId": "whey-protein", "quantity_g": 30, "state": "raw", "notes": "1 scoop" },
            { "productId": "bananas", "quantity_g": 120, "state": "raw", "notes": "1 medium" },
            { "productId": "rolled-oats", "quantity_g": 35, "state": "raw", "notes": "raw, blended" },
            { "productId": "rice-cakes", "quantity_g": 18, "state": "raw", "notes": "2 cakes" }
          ],
          "prep": "Blend whey, oats, banana, and water. Eat rice cakes on the side.",
          "batchPrep": false
        },
        {
          "slot": "post-workout",
          "time": "20:30",
          "name": "Chicken Breast with Rice",
          "ingredients": [
            { "productId": "chicken-breast", "quantity_g": 140, "state": "cooked", "notes": "from batch cook" },
            { "productId": "white-basmati-rice", "quantity_g": 160, "state": "cooked", "notes": "from batch cook" },
            { "productId": "soy-sauce", "quantity_g": 10, "state": "raw", "notes": "for flavour" }
          ],
          "prep": "Reheat chicken and rice. Drizzle soy sauce.",
          "batchPrep": true
        },
        {
          "slot": "pre-bed",
          "time": "23:00",
          "name": "Cottage Cheese with Mixed Nuts",
          "ingredients": [
            { "productId": "cottage-cheese-fat-free", "quantity_g": 250, "state": "raw", "notes": "smooth or chunky" },
            { "productId": "mixed-nuts", "quantity_g": 35, "state": "raw", "notes": "unsalted" }
          ],
          "prep": "Serve cottage cheese topped with nuts.",
          "batchPrep": false
        }
      ]
    },
    {
      "day": 11,
      "dayOfWeek": "Thursday",
      "date": "2026-03-05",
      "prepDay": false,
      "meals": [
        {
          "slot": "breakfast",
          "time": "07:00",
          "name": "Cottage Cheese Oats with Whey & Nuts",
          "ingredients": [
            { "productId": "cottage-cheese-fat-free", "quantity_g": 100, "state": "raw", "notes": "smooth" },
            { "productId": "rolled-oats", "quantity_g": 50, "state": "raw", "notes": "raw, cooked with water" },
            { "productId": "whey-protein", "quantity_g": 30, "state": "raw", "notes": "1 scoop, stirred in" },
            { "productId": "mixed-nuts", "quantity_g": 30, "state": "raw", "notes": "unsalted, chopped" },
            { "productId": "honey", "quantity_g": 15, "state": "raw", "notes": "drizzle" }
          ],
          "prep": "Cook oats with water. Stir in whey and cottage cheese. Top with nuts and honey.",
          "batchPrep": false
        },
        {
          "slot": "lunch",
          "time": "12:30",
          "name": "Grilled Chicken Breast with Rice & Roasted Butternut",
          "ingredients": [
            { "productId": "chicken-breast", "quantity_g": 130, "state": "cooked", "notes": "from batch cook" },
            { "productId": "white-basmati-rice", "quantity_g": 130, "state": "cooked", "notes": "from batch cook" },
            { "productId": "frozen-butternut", "quantity_g": 120, "state": "cooked", "notes": "from batch cook" }
          ],
          "prep": "Reheat batch-cooked chicken, rice, and butternut.",
          "batchPrep": true
        },
        {
          "slot": "pre-workout",
          "time": "17:00",
          "name": "Basa Fillet with Rice",
          "ingredients": [
            { "productId": "basa-fillets", "quantity_g": 200, "state": "raw", "notes": "2 fillets" },
            { "productId": "white-basmati-rice", "quantity_g": 150, "state": "cooked", "notes": "from batch cook" },
            { "productId": "soy-sauce", "quantity_g": 10, "state": "raw", "notes": "for flavour" }
          ],
          "prep": "Bake basa fillets at 200C for 12 min the evening before. Store in container with rice. Reheat in microwave at office.",
          "batchPrep": false
        },
        {
          "slot": "post-workout",
          "time": "20:30",
          "name": "Whey Shake with Banana & Oats",
          "ingredients": [
            { "productId": "whey-protein", "quantity_g": 30, "state": "raw", "notes": "1 scoop" },
            { "productId": "bananas", "quantity_g": 120, "state": "raw", "notes": "1 medium" },
            { "productId": "rolled-oats", "quantity_g": 40, "state": "raw", "notes": "raw, blended" },
            { "productId": "peanut-butter", "quantity_g": 25, "state": "raw", "notes": "blended in" }
          ],
          "prep": "Blend whey, oats, banana, peanut butter, and water. Add creatine 5g.",
          "batchPrep": false
        },
        {
          "slot": "pre-bed",
          "time": "23:00",
          "name": "Scrambled Eggs with Cheese",
          "ingredients": [
            { "productId": "free-range-eggs", "quantity_g": 150, "state": "raw", "notes": "3 eggs" },
            { "productId": "cheddar-cheese", "quantity_g": 25, "state": "raw", "notes": "grated" }
          ],
          "prep": "Scramble 3 eggs. Top with cheese to melt.",
          "batchPrep": false
        }
      ]
    },
    {
      "day": 12,
      "dayOfWeek": "Friday",
      "date": "2026-03-06",
      "prepDay": false,
      "meals": [
        {
          "slot": "breakfast",
          "time": "07:00",
          "name": "Egg White Omelette with Toast",
          "ingredients": [
            { "productId": "liquid-egg-whites", "quantity_g": 130, "state": "raw", "notes": "130ml" },
            { "productId": "free-range-eggs", "quantity_g": 100, "state": "raw", "notes": "2 whole eggs" },
            { "productId": "wholewheat-bread", "quantity_g": 60, "state": "raw", "notes": "2 slices" },
            { "productId": "cheddar-cheese", "quantity_g": 20, "state": "raw", "notes": "grated, in omelette" }
          ],
          "prep": "Whisk egg whites and whole eggs. Cook omelette, add cheese. Serve with toast.",
          "batchPrep": false
        },
        {
          "slot": "lunch",
          "time": "12:30",
          "name": "Lean Beef Mince Bolognese with Pasta",
          "ingredients": [
            { "productId": "lean-beef-mince", "quantity_g": 120, "state": "cooked", "notes": "from batch cook" },
            { "productId": "penne-pasta", "quantity_g": 155, "state": "cooked", "notes": "penne" },
            { "productId": "napolitana-sauce", "quantity_g": 80, "state": "raw", "notes": "Woolworths napolitana" }
          ],
          "prep": "Reheat mince with sauce. Cook or reheat pasta. Combine.",
          "batchPrep": true
        },
        {
          "slot": "pre-workout",
          "time": "17:00",
          "name": "Chicken Breast with Rice & Mixed Veg",
          "ingredients": [
            { "productId": "chicken-breast", "quantity_g": 120, "state": "cooked", "notes": "from batch cook" },
            { "productId": "white-basmati-rice", "quantity_g": 150, "state": "cooked", "notes": "from batch cook" },
            { "productId": "frozen-mixed-veg", "quantity_g": 100, "state": "raw", "notes": "microwave steamed 3 min" }
          ],
          "prep": "Reheat chicken and rice. Microwave steam mixed veg for 3 min.",
          "batchPrep": true
        },
        {
          "slot": "post-workout",
          "time": "20:30",
          "name": "Woolworths Chicken Ready Meal with Whey Shake",
          "ingredients": [
            { "productId": "chicken-rice-ready-meal", "quantity_g": 350, "state": "raw", "notes": "1 tray" },
            { "productId": "whey-protein", "quantity_g": 20, "state": "raw", "notes": "2/3 scoop in water" }
          ],
          "prep": "Microwave ready meal. Mix whey shake on the side. Add creatine to shake.",
          "batchPrep": false
        },
        {
          "slot": "pre-bed",
          "time": "23:00",
          "name": "Cottage Cheese with Mixed Nuts",
          "ingredients": [
            { "productId": "cottage-cheese-fat-free", "quantity_g": 200, "state": "raw", "notes": "smooth or chunky" },
            { "productId": "mixed-nuts", "quantity_g": 25, "state": "raw", "notes": "unsalted" }
          ],
          "prep": "Serve cottage cheese topped with nuts.",
          "batchPrep": false
        }
      ]
    },
    {
      "day": 13,
      "dayOfWeek": "Saturday",
      "date": "2026-03-07",
      "prepDay": false,
      "meals": [
        {
          "slot": "breakfast",
          "time": "08:30",
          "name": "Oats with Whey, Peanut Butter & Banana",
          "ingredients": [
            { "productId": "rolled-oats", "quantity_g": 60, "state": "raw", "notes": "raw" },
            { "productId": "whey-protein", "quantity_g": 30, "state": "raw", "notes": "1 scoop" },
            { "productId": "peanut-butter", "quantity_g": 15, "state": "raw", "notes": "smooth" },
            { "productId": "bananas", "quantity_g": 100, "state": "raw", "notes": "1 small, sliced" }
          ],
          "prep": "Cook oats with water. Stir in whey. Top with banana and peanut butter.",
          "batchPrep": false
        },
        {
          "slot": "lunch",
          "time": "12:30",
          "name": "Woolworths Chicken Ready Meal with Extra Protein",
          "ingredients": [
            { "productId": "chicken-veg-ready-meal", "quantity_g": 350, "state": "raw", "notes": "1 tray" },
            { "productId": "free-range-eggs", "quantity_g": 150, "state": "raw", "notes": "3 eggs, from batch" }
          ],
          "prep": "Microwave ready meal. Eat 3 boiled eggs on the side.",
          "batchPrep": false
        },
        {
          "slot": "pre-workout",
          "time": "17:00",
          "name": "Lean Mince with Sweet Potato",
          "ingredients": [
            { "productId": "lean-beef-mince", "quantity_g": 100, "state": "cooked", "notes": "from batch cook (last portions)" },
            { "productId": "sweet-potatoes", "quantity_g": 200, "state": "cooked", "notes": "microwave baked" }
          ],
          "prep": "Microwave sweet potato. Reheat last of batch-cooked mince.",
          "batchPrep": true
        },
        {
          "slot": "post-workout",
          "time": "20:30",
          "name": "Whey Shake with Banana & Oats",
          "ingredients": [
            { "productId": "whey-protein", "quantity_g": 40, "state": "raw", "notes": "1.3 scoops" },
            { "productId": "bananas", "quantity_g": 120, "state": "raw", "notes": "1 medium" },
            { "productId": "rolled-oats", "quantity_g": 50, "state": "raw", "notes": "raw, blended" }
          ],
          "prep": "Blend whey, oats, banana, and water. Add creatine 5g.",
          "batchPrep": false
        },
        {
          "slot": "pre-bed",
          "time": "23:00",
          "name": "Cottage Cheese with Nuts",
          "ingredients": [
            { "productId": "cottage-cheese-fat-free", "quantity_g": 250, "state": "raw", "notes": "smooth or chunky" },
            { "productId": "mixed-nuts", "quantity_g": 15, "state": "raw", "notes": "unsalted" }
          ],
          "prep": "Serve cottage cheese in bowl, top with nuts.",
          "batchPrep": false
        }
      ]
    },
    {
      "day": 14,
      "dayOfWeek": "Sunday",
      "date": "2026-03-08",
      "prepDay": false,
      "meals": [
        {
          "slot": "breakfast",
          "time": "08:30",
          "name": "Scrambled Eggs with Toast & Banana",
          "ingredients": [
            { "productId": "free-range-eggs", "quantity_g": 150, "state": "raw", "notes": "3 eggs" },
            { "productId": "wholewheat-bread", "quantity_g": 60, "state": "raw", "notes": "2 slices" },
            { "productId": "bananas", "quantity_g": 100, "state": "raw", "notes": "1 small" },
            { "productId": "peanut-butter", "quantity_g": 25, "state": "raw", "notes": "on toast" }
          ],
          "prep": "Scramble 3 eggs. Toast bread, spread with peanut butter. Banana on the side.",
          "batchPrep": false
        },
        {
          "slot": "lunch",
          "time": "12:30",
          "name": "Grilled Chicken Breast with Rice & Roasted Butternut",
          "ingredients": [
            { "productId": "chicken-breast", "quantity_g": 130, "state": "cooked", "notes": "from batch cook" },
            { "productId": "white-basmati-rice", "quantity_g": 120, "state": "cooked", "notes": "from batch cook" },
            { "productId": "frozen-butternut", "quantity_g": 120, "state": "cooked", "notes": "from batch cook" }
          ],
          "prep": "Reheat batch-cooked chicken, rice, and butternut.",
          "batchPrep": true
        },
        {
          "slot": "pre-workout",
          "time": "17:00",
          "name": "Chicken Breast with Rice & Mixed Veg",
          "ingredients": [
            { "productId": "chicken-breast", "quantity_g": 120, "state": "cooked", "notes": "from batch cook" },
            { "productId": "white-basmati-rice", "quantity_g": 130, "state": "cooked", "notes": "from batch cook" },
            { "productId": "frozen-mixed-veg", "quantity_g": 100, "state": "raw", "notes": "microwave steamed 3 min" }
          ],
          "prep": "Reheat chicken and rice. Microwave steam mixed veg for 3 min.",
          "batchPrep": true
        },
        {
          "slot": "post-workout",
          "time": "20:30",
          "name": "Whey Shake with Banana & Oats",
          "ingredients": [
            { "productId": "whey-protein", "quantity_g": 30, "state": "raw", "notes": "1 scoop" },
            { "productId": "bananas", "quantity_g": 100, "state": "raw", "notes": "1 small" },
            { "productId": "rolled-oats", "quantity_g": 40, "state": "raw", "notes": "raw, blended" },
            { "productId": "peanut-butter", "quantity_g": 20, "state": "raw", "notes": "blended in" }
          ],
          "prep": "Blend whey, oats, banana, peanut butter, and water. Add creatine 5g.",
          "batchPrep": false
        },
        {
          "slot": "pre-bed",
          "time": "23:00",
          "name": "Fat Free Yoghurt with Whey & Nuts",
          "ingredients": [
            { "productId": "fat-free-yoghurt", "quantity_g": 200, "state": "raw", "notes": "Woolworths plain" },
            { "productId": "whey-protein", "quantity_g": 30, "state": "raw", "notes": "1 scoop" },
            { "productId": "mixed-nuts", "quantity_g": 40, "state": "raw", "notes": "unsalted" }
          ],
          "prep": "Mix whey into yoghurt. Top with nuts.",
          "batchPrep": false
        }
      ]
    }
  ]
};

// === BUILD: Inlined engine.js ===
/**
 * Computation engine for diet meal plan.
 * Pure functions — no DOM, no side effects, no network.
 * Runs in both browser (ES module) and Node.js.
 */

/**
 * Look up a product by ID in the catalog.
 * @param {string} productId
 * @param {object} catalog - { products: [...] }
 * @returns {object|null} The product object or null if not found
 */
function getProduct(productId, catalog) {
  return catalog.products.find(p => p.id === productId) ?? null;
}

/**
 * Compute macros for a single meal.
 * @param {object} meal - { ingredients: [{ productId, quantity_g, state? }] }
 * @param {object} catalog - { products: [...] }
 * @returns {{ calories: number, protein_g: number, carbs_g: number, fat_g: number, fibre_g: number }}
 */
function computeMealMacros(meal, catalog) {
  const totals = { calories: 0, protein_g: 0, carbs_g: 0, fat_g: 0, fibre_g: 0 };

  for (const ing of meal.ingredients) {
    const product = getProduct(ing.productId, catalog);
    if (!product) throw new Error(`Product not found: ${ing.productId}`);

    // Convert cooked weight back to raw/dry if needed
    let rawQty = ing.quantity_g;
    if (ing.state === 'cooked' && product.cookingYield) {
      rawQty = ing.quantity_g / product.cookingYield;
    }

    const factor = rawQty / 100;
    totals.calories += product.per100g.calories * factor;
    totals.protein_g += product.per100g.protein_g * factor;
    totals.carbs_g += product.per100g.carbs_g * factor;
    totals.fat_g += product.per100g.fat_g * factor;
    totals.fibre_g += (product.per100g.fibre_g ?? 0) * factor;
  }

  // Round to 1 decimal place
  for (const key of Object.keys(totals)) {
    totals[key] = Math.round(totals[key] * 10) / 10;
  }
  return totals;
}

/**
 * Compute total macros for a day by summing all meals.
 * @param {object} day - { meals: [...] }
 * @param {object} catalog
 * @returns {{ calories, protein_g, carbs_g, fat_g, fibre_g }}
 */
function computeDayTotals(day, catalog) {
  const totals = { calories: 0, protein_g: 0, carbs_g: 0, fat_g: 0, fibre_g: 0 };

  for (const meal of day.meals) {
    const mealMacros = computeMealMacros(meal, catalog);
    for (const key of Object.keys(totals)) {
      totals[key] += mealMacros[key];
    }
  }

  for (const key of Object.keys(totals)) {
    totals[key] = Math.round(totals[key] * 10) / 10;
  }
  return totals;
}

/**
 * Compute average daily macros for a set of days.
 * @param {object} plan - { days: [...] }
 * @param {object} catalog
 * @param {number[]} dayNumbers - Which day indices to include
 * @returns {{ avgCalories, avgProtein_g, avgCarbs_g, avgFat_g, avgFibre_g }}
 */
function computeWeeklyAverages(plan, catalog, dayNumbers) {
  const days = plan.days.filter(d => dayNumbers.includes(d.day));
  if (days.length === 0) return { avgCalories: 0, avgProtein_g: 0, avgCarbs_g: 0, avgFat_g: 0, avgFibre_g: 0 };

  const sums = { calories: 0, protein_g: 0, carbs_g: 0, fat_g: 0, fibre_g: 0 };
  for (const day of days) {
    const dt = computeDayTotals(day, catalog);
    for (const key of Object.keys(sums)) sums[key] += dt[key];
  }

  const n = days.length;
  return {
    avgCalories: Math.round(sums.calories / n),
    avgProtein_g: Math.round(sums.protein_g / n),
    avgCarbs_g: Math.round(sums.carbs_g / n),
    avgFat_g: Math.round(sums.fat_g / n),
    avgFibre_g: Math.round(sums.fibre_g / n)
  };
}

/**
 * Validate a plan against daily targets.
 * @param {object} plan - { days: [...] }
 * @param {object} catalog
 * @param {object} targets - { calories, protein_g, carbs_g, fat_g }
 * @param {number} [tolerancePct=5] - Acceptable deviation percentage
 * @returns {{ valid: boolean, warnings: string[], dayBreakdown: object[] }}
 */
function validatePlan(plan, catalog, targets, tolerancePct = 5) {
  const warnings = [];
  const dayBreakdown = [];

  for (const day of plan.days) {
    if (day.meals.length === 0) continue; // Skip prep days

    const totals = computeDayTotals(day, catalog);
    const dayWarnings = [];

    for (const [key, target] of Object.entries(targets)) {
      const actual = totals[key];
      if (target === 0) continue;
      const pctDiff = Math.abs((actual - target) / target) * 100;
      if (pctDiff > tolerancePct) {
        const direction = actual > target ? 'over' : 'under';
        dayWarnings.push(`Day ${day.day}: ${key} is ${actual} (${direction} target ${target} by ${pctDiff.toFixed(1)}%)`);
      }
    }

    warnings.push(...dayWarnings);
    dayBreakdown.push({ day: day.day, totals, warnings: dayWarnings });
  }

  return { valid: warnings.length === 0, warnings, dayBreakdown };
}

/**
 * Compute shopping list from a plan, accounting for inventory.
 * All quantities are in raw/dry weight (as purchased).
 * @param {object} plan - { days: [...] }
 * @param {object} catalog
 * @param {object} inventory - { productId: remaining_g }
 * @param {number[]} [dayNumbers] - Optional: only include these days (for weekly shopping)
 * @returns {Array<{ productId, name, totalNeeded_g, packs, priceZAR, category }>}
 */
function computeShoppingList(plan, catalog, inventory, dayNumbers) {
  const needs = {};  // productId -> totalRawGrams

  const days = dayNumbers
    ? plan.days.filter(d => dayNumbers.includes(d.day))
    : plan.days;

  for (const day of days) {
    for (const meal of day.meals) {
      for (const ing of meal.ingredients) {
        const product = getProduct(ing.productId, catalog);
        if (!product) throw new Error(`Product not found: ${ing.productId}`);

        let rawQty = ing.quantity_g;
        if (ing.state === 'cooked' && product.cookingYield) {
          rawQty = ing.quantity_g / product.cookingYield;
        }

        needs[ing.productId] = (needs[ing.productId] ?? 0) + rawQty;
      }
    }
  }

  // Subtract inventory
  for (const [productId, remaining] of Object.entries(inventory)) {
    if (needs[productId]) {
      needs[productId] -= remaining;
    }
  }

  // Build shopping list
  const list = [];
  for (const [productId, needed] of Object.entries(needs)) {
    if (needed <= 0) continue;

    const product = getProduct(productId, catalog);
    const packs = Math.ceil(needed / product.packSize_g);
    list.push({
      productId,
      name: product.name,
      category: product.category,
      totalNeeded_g: Math.round(needed),
      packs,
      priceZAR: Math.round(packs * product.priceZAR * 100) / 100
    });
  }

  return list.sort((a, b) => (a.category ?? '').localeCompare(b.category ?? ''));
}

/**
 * Compute current inventory after a plan cycle.
 * @param {Array} shopping - Shopping list with packs purchased
 * @param {object} plan - The plan that was followed
 * @param {object} catalog
 * @param {object} tracking - { "dayNum-slot": { skipped: bool } }
 * @param {object} adjustments - { productId: delta_g } (negative = removed, positive = added)
 * @returns {object} { productId: remaining_g }
 */
function computeInventory(shopping, plan, catalog, tracking, adjustments) {
  const stock = {};

  // Add purchased quantities
  for (const item of shopping) {
    const product = getProduct(item.productId, catalog);
    stock[item.productId] = (stock[item.productId] ?? 0) + (item.packs * product.packSize_g);
  }

  // Subtract planned usage (unless meal was skipped)
  for (const day of plan.days) {
    for (const meal of day.meals) {
      const trackKey = `${day.day}-${meal.slot}`;
      const wasSkipped = tracking[trackKey]?.skipped === true;

      if (!wasSkipped) {
        for (const ing of meal.ingredients) {
          let rawQty = ing.quantity_g;
          const product = getProduct(ing.productId, catalog);
          if (ing.state === 'cooked' && product?.cookingYield) {
            rawQty = ing.quantity_g / product.cookingYield;
          }
          stock[ing.productId] = (stock[ing.productId] ?? 0) - rawQty;
        }
      }
    }
  }

  // Apply manual adjustments
  for (const [productId, delta] of Object.entries(adjustments)) {
    stock[productId] = (stock[productId] ?? 0) + delta;
  }

  // Round and remove negatives (can't have negative stock)
  for (const key of Object.keys(stock)) {
    stock[key] = Math.max(0, Math.round(stock[key]));
  }

  return stock;
}

// === BUILD: Inlined supabase.js ===
/**
 * Supabase sync layer: localStorage-first, Supabase background sync.
 * Works offline — all features use localStorage as primary store.
 * Supabase syncs in the background when online + authenticated.
 */

const SUPABASE_URL = 'https://nmlvazkuxohdljrgzvpr.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_2YRpljbgVcOCGa719BndQA__z3fSLKS';

let supabaseClient = null;

/**
 * Initialize Supabase client (lazy, only when online).
 * Uses supabase-js loaded from CDN via script tag in index.html.
 * @returns {object} The Supabase client instance
 */
async function initSupabase() {
  if (supabaseClient) return supabaseClient;

  if (!window.supabase) {
    throw new Error('Supabase JS not loaded. Add the CDN script tag to index.html.');
  }

  const { createClient } = window.supabase;
  supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  return supabaseClient;
}

/**
 * Check if Supabase is configured (not using placeholder values).
 * @returns {boolean}
 */
function isConfigured() {
  return SUPABASE_URL !== '__SUPABASE_URL__' && SUPABASE_ANON_KEY !== '__SUPABASE_ANON_KEY__';
}

// Race a promise against a timeout. Rejects with a descriptive error if ms elapses first.
function withTimeout(promise, ms = 8000) {
  return Promise.race([
    promise,
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error(`Supabase timed out after ${ms}ms — project may be paused`)), ms)
    )
  ]);
}

/**
 * Get current authenticated user, or null.
 * @returns {object|null} The user object or null
 */
async function getUser() {
  if (!isConfigured()) return null;
  try {
    const client = await initSupabase();
    const { data: { user } } = await withTimeout(client.auth.getUser(), 5000);
    return user;
  } catch {
    return null;
  }
}

/**
 * Sign in with magic link (email).
 * @param {string} email
 * @returns {object} Supabase auth response
 */
async function signIn(email) {
  const client = await initSupabase();
  return client.auth.signInWithOtp({
    email,
    options: { emailRedirectTo: 'https://thatguywithlions.github.io/meal-plan/' }
  });
}

/**
 * Sign out the current user.
 * @returns {object} Supabase auth response
 */
async function signOut() {
  const client = await initSupabase();
  return client.auth.signOut();
}

/**
 * Sync tracking data: localStorage -> Supabase.
 * Called after each tracking change.
 * @param {string} planId - e.g. "plan-001"
 * @param {object} trackingData - { meals: { "1-breakfast": { completed, rating, ... } } }
 */
async function syncTracking(planId, trackingData) {
  if (!currentUser) return;
  const client = await initSupabase();

  const meals = trackingData.meals ?? trackingData;
  let lastError = null;
  for (const [key, data] of Object.entries(meals)) {
    const parts = key.split('-');
    const dayIndex = parseInt(parts[0]);
    const slot = parts.slice(1).join('-');

    const { error } = await withTimeout(client.from('tracking').upsert({
      user_id: currentUser.id,
      plan_id: planId,
      day_index: dayIndex,
      slot,
      completed: data.completed ?? false,
      rating: data.rating ?? null,
      skipped: data.skipped ?? false,
      skip_reason: data.skipReason ?? null,
      substitution: data.substitution ?? null,
      notes: data.notes ?? null,
      updated_at: new Date().toISOString()
    }, { onConflict: 'user_id,plan_id,day_index,slot' }));
    if (error) { console.warn(`Failed to sync tracking for ${key}:`, error); lastError = error; }
  }
  if (lastError) throw lastError;
}

/**
 * Sync inventory data: localStorage -> Supabase.
 * @param {object} inventoryData - { productId: remaining_g }
 */
async function syncInventory(inventoryData) {
  if (!currentUser) return;
  const client = await initSupabase();

  let lastError = null;
  for (const [productId, remaining] of Object.entries(inventoryData)) {
    const { error } = await withTimeout(client.from('inventory').upsert({
      user_id: currentUser.id,
      product_id: productId,
      remaining_g: remaining,
      source: 'derived',
      updated_at: new Date().toISOString()
    }, { onConflict: 'user_id,product_id' }));
    if (error) { console.warn(`Failed to sync inventory for ${productId}:`, error); lastError = error; }
  }
  if (lastError) throw lastError;
}

/**
 * Sync shopping check-off data: localStorage -> Supabase.
 * @param {string} planId
 * @param {number} week - 1 or 2
 * @param {object} checksData - { productId: boolean }
 */
async function syncShoppingChecks(planId, week, checksData) {
  if (!currentUser) return;
  const client = await initSupabase();

  let lastError = null;
  for (const [productId, checked] of Object.entries(checksData)) {
    const { error } = await withTimeout(client.from('shopping_checks').upsert({
      user_id: currentUser.id,
      plan_id: planId,
      week,
      product_id: productId,
      checked,
      updated_at: new Date().toISOString()
    }, { onConflict: 'user_id,plan_id,week,product_id' }));
    if (error) { console.warn(`Failed to sync shopping check for ${productId}:`, error); lastError = error; }
  }
  if (lastError) throw lastError;
}

/**
 * Load tracking from Supabase (for restoring on new device).
 * @param {string} planId
 * @returns {object|null} Tracking data keyed by "dayIndex-slot", or null
 */
async function loadTracking(planId) {
  if (!currentUser) return null;
  const client = await initSupabase();

  try {
    const { data, error } = await withTimeout(client.from('tracking')
      .select('*')
      .eq('user_id', currentUser.id)
      .eq('plan_id', planId));

    if (error) throw error;
    if (!data || data.length === 0) return null;

    // Convert rows back to the localStorage format
    const meals = {};
    for (const row of data) {
      const key = `${row.day_index}-${row.slot}`;
      meals[key] = {
        completed: row.completed,
        rating: row.rating,
        skipped: row.skipped,
        skipReason: row.skip_reason,
        substitution: row.substitution,
        notes: row.notes,
        timestamp: new Date(row.updated_at).getTime()
      };
    }
    return { planId, meals };
  } catch (err) {
    console.warn('Failed to load tracking from Supabase:', err);
    return null;
  }
}

/**
 * Load inventory from Supabase.
 * @returns {object|null} Inventory data keyed by productId, or null
 */
async function loadInventory() {
  if (!currentUser) return null;
  const client = await initSupabase();

  try {
    const { data, error } = await withTimeout(client.from('inventory')
      .select('*')
      .eq('user_id', currentUser.id));

    if (error) throw error;
    if (!data || data.length === 0) return null;

    // Convert rows to { productId: remaining_g }
    const inventory = {};
    for (const row of data) {
      inventory[row.product_id] = row.remaining_g;
    }
    return inventory;
  } catch (err) {
    console.warn('Failed to load inventory from Supabase:', err);
    return null;
  }
}

/**
 * Load shopping checks from Supabase.
 * @param {string} planId
 * @param {number} week
 * @returns {object|null} Shopping checks keyed by productId, or null
 */
async function loadShoppingChecks(planId, week) {
  if (!currentUser) return null;
  const client = await initSupabase();

  try {
    const { data, error } = await withTimeout(client.from('shopping_checks')
      .select('*')
      .eq('user_id', currentUser.id)
      .eq('plan_id', planId)
      .eq('week', week));

    if (error) throw error;
    if (!data || data.length === 0) return null;

    const checks = {};
    for (const row of data) {
      checks[row.product_id] = row.checked;
    }
    return checks;
  } catch (err) {
    console.warn('Failed to load shopping checks from Supabase:', err);
    return null;
  }
}

// === BUILD: Import alias resolution ===
const isSupabaseConfigured = isConfigured;

// ============================================
// Data Loading
// ============================================
(async () => {
const catalog = __CATALOG__;
const plan = __PLAN__;

// ============================================
// Helpers
// ============================================
function getCurrentDayIndex() {
  const start = new Date(plan.startDate + 'T00:00:00');
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const diff = Math.floor((today - start) / 86400000);
  if (diff < 0) return 0;
  if (diff > 14) return 14;
  return diff;
}

function loadLS(key) {
  try { return JSON.parse(localStorage.getItem(key)); } catch { return null; }
}

function saveLS(key, val) {
  localStorage.setItem(key, JSON.stringify(val));
}

function getDayByNum(num) {
  return plan.days.find(d => d.day === num);
}

function formatDate(dateStr) {
  const d = new Date(dateStr + 'T00:00:00');
  return d.toLocaleDateString('en-ZA', { day: 'numeric', month: 'short' });
}

function pct(actual, target) {
  if (target === 0) return 0;
  return Math.min(Math.round((actual / target) * 100), 150);
}

const var_protein = '#4CAF50';
const var_carbs = '#FF9800';
const var_fat = '#2196F3';
const var_calories = '#F44336';

function macroColor(pctVal) {
  if (pctVal >= 95 && pctVal <= 110) return var_protein;
  if ((pctVal >= 80 && pctVal < 95) || (pctVal > 110 && pctVal <= 125)) return var_carbs;
  return var_calories;
}

function round1(n) { return Math.round(n * 10) / 10; }

// ============================================
// State
// ============================================
const state = {
  currentTab: 'today',
  selectedDay: getCurrentDayIndex() || 1,
  selectedWeek: getCurrentDayIndex() <= 7 ? 1 : 2,
  todayOverride: null,
  tracking: loadLS(`tracking_${plan.planId}`) || {},
  shoppingChecks: loadLS(`shopping_${plan.planId}`) || {},
  inventoryAdj: loadLS(`inventory_adj_${plan.planId}`) || {},
};

function getTodayDayIndex() {
  if (state.todayOverride !== null) return state.todayOverride;
  return getCurrentDayIndex();
}

// ============================================
// Tab Navigation
// ============================================
const $content = document.getElementById('tab-content');
const $header = document.getElementById('header-title');
const $headerInfo = document.getElementById('header-info');

document.querySelectorAll('.nav-btn').forEach(btn => {
  btn.addEventListener('click', () => switchTab(btn.dataset.tab));
});

function switchTab(tab) {
  state.currentTab = tab;
  document.querySelectorAll('.nav-btn').forEach(b =>
    b.classList.toggle('active', b.dataset.tab === tab)
  );
  renderTab();
}

function renderTab() {
  switch (state.currentTab) {
    case 'today': renderToday(); break;
    case 'plan': renderPlan(); break;
    case 'shop': renderShop(); break;
    case 'stock': renderStock(); break;
    case 'stats': renderStats(); break;
  }
}

// ============================================
// TODAY TAB
// ============================================
function renderToday() {
  const dayIdx = getTodayDayIndex();
  const autoIdx = getCurrentDayIndex();
  const isOverridden = state.todayOverride !== null && state.todayOverride !== autoIdx;
  const day = getDayByNum(dayIdx);
  $header.textContent = 'Today';

  if (!day) {
    $headerInfo.textContent = '';
    $content.innerHTML = '<div class="empty-state"><div class="icon">&#128197;</div><h3>Plan not active</h3><p>Your plan runs ' + plan.startDate + ' to ' + plan.endDate + '</p></div>';
    return;
  }

  $headerInfo.textContent = 'Day ' + day.day + ' - ' + day.dayOfWeek;

  // Day navigation bar
  const canPrev = dayIdx > 0;
  const canNext = dayIdx < 14;
  let navHtml = '<div class="today-day-nav">'
    + '<button class="today-nav-btn" id="today-prev"' + (canPrev ? '' : ' disabled') + '>&#9664;</button>'
    + '<div class="today-nav-center">'
    + '<span class="today-nav-day">Day ' + day.day + ' \u2014 ' + day.dayOfWeek + '</span>'
    + '<span class="today-nav-date">' + formatDate(day.date) + (isOverridden ? ' (manually selected)' : '') + '</span>'
    + '</div>'
    + '<button class="today-nav-btn" id="today-next"' + (canNext ? '' : ' disabled') + '>&#9654;</button>'
    + '</div>';
  if (isOverridden) {
    navHtml += '<div style="text-align:center;margin-bottom:8px">'
      + '<button class="btn btn-secondary btn-small" id="today-reset">Back to today (Day ' + autoIdx + ')</button>'
      + '</div>';
  }

  if (day.meals.length === 0) {
    $content.innerHTML = navHtml + '<div class="prep-banner"><h3>Prep Day</h3><p>' + (day.batchPrepInstructions || 'No prep instructions.') + '</p></div>';
    attachTodayNavEvents();
    return;
  }

  const dayTotals = computeDayTotals(day, catalog);
  const targets = plan.dailyTargets;
  let completedTotals = { calories: 0, protein_g: 0, carbs_g: 0, fat_g: 0 };

  for (const meal of day.meals) {
    const key = `${day.day}-${meal.slot}`;
    const t = state.tracking[key];
    if (t && t.completed) {
      const mm = computeMealMacros(meal, catalog);
      completedTotals.calories += mm.calories;
      completedTotals.protein_g += mm.protein_g;
      completedTotals.carbs_g += mm.carbs_g;
      completedTotals.fat_g += mm.fat_g;
    }
  }

  const allDone = day.meals.every(m => {
    const t = state.tracking[`${day.day}-${m.slot}`];
    return t && (t.completed || t.skipped);
  });

  let html = '';

  // Daily progress card
  html += `<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <span style="font-size:0.8rem;font-weight:600">Daily Progress</span>
      <span style="font-size:0.75rem;color:var(--text-secondary)">${formatDate(day.date)}</span>
    </div>
    <div class="macro-progress">
      ${macroProgressRow('Cal', completedTotals.calories, targets.calories, var_calories)}
      ${macroProgressRow('P', completedTotals.protein_g, targets.protein_g, var_protein)}
      ${macroProgressRow('C', completedTotals.carbs_g, targets.carbs_g, var_carbs)}
      ${macroProgressRow('F', completedTotals.fat_g, targets.fat_g, var_fat)}
    </div>
    <div style="font-size:0.7rem;color:var(--text-secondary);text-align:center;margin-top:4px">
      Day total: ${Math.round(dayTotals.calories)} kcal | ${round1(dayTotals.protein_g)}g P | ${round1(dayTotals.carbs_g)}g C | ${round1(dayTotals.fat_g)}g F
    </div>
  </div>`;

  if (allDone) {
    html += `<div class="day-complete">
      <div class="icon">&#127881;</div>
      <h3>Day Complete!</h3>
      <p>${Math.round(completedTotals.calories)} kcal | ${round1(completedTotals.protein_g)}g protein consumed</p>
    </div>`;
  }

  // Meal cards
  for (const meal of day.meals) {
    html += renderMealCard(day, meal, true);
  }

  $content.innerHTML = navHtml + html;
  attachTodayNavEvents();
  attachMealCardEvents(day);
}

function attachTodayNavEvents() {
  const prevBtn = document.getElementById('today-prev');
  const nextBtn = document.getElementById('today-next');
  const resetBtn = document.getElementById('today-reset');
  if (prevBtn) prevBtn.onclick = function() {
    const cur = getTodayDayIndex();
    if (cur > 0) { state.todayOverride = cur - 1; renderToday(); }
  };
  if (nextBtn) nextBtn.onclick = function() {
    const cur = getTodayDayIndex();
    if (cur < 14) { state.todayOverride = cur + 1; renderToday(); }
  };
  if (resetBtn) resetBtn.onclick = function() {
    state.todayOverride = null;
    renderToday();
  };
}

function macroProgressRow(label, actual, target, color) {
  const p = Math.min(pct(actual, target), 100);
  return `<div class="macro-progress-row">
    <span class="macro-progress-label" style="color:${color}">${label}</span>
    <div class="macro-progress-bar"><div class="fill" style="width:${p}%;background:${color}"></div></div>
    <span class="macro-progress-value">${Math.round(actual)} / ${target}</span>
  </div>`;
}

function renderMealCard(day, meal, showActions) {
  const macros = computeMealMacros(meal, catalog);
  const key = `${day.day}-${meal.slot}`;
  const t = state.tracking[key] || {};
  const isDone = t.completed;
  const isSkipped = t.skipped;
  const stateClass = isDone ? 'done' : isSkipped ? 'skipped' : '';

  let html = `<div class="card meal-card ${stateClass}" data-key="${key}">
    <div class="card-header">
      <div>
        <div class="card-title">${meal.name}</div>
        <div class="card-subtitle">${meal.time}${meal.batchPrep ? ' - Batch prep' : ''}</div>
      </div>
      <span class="slot-badge">${formatSlot(meal.slot)}</span>
    </div>
    <div class="macro-row">
      <span class="macro-badge cal">${Math.round(macros.calories)} kcal</span>
      <span class="macro-badge pro">${round1(macros.protein_g)}g P</span>
      <span class="macro-badge carb">${round1(macros.carbs_g)}g C</span>
      <span class="macro-badge fat">${round1(macros.fat_g)}g F</span>
    </div>`;

  // Expandable ingredients
  html += `<div class="expandable-trigger" data-expand="${key}-ing">Ingredients (${meal.ingredients.length})</div>
    <div class="expandable-content" id="expand-${key}-ing">
      <ul class="ingredient-list">
        ${meal.ingredients.map(ing => {
          const prod = getProduct(ing.productId, catalog);
          const name = prod ? prod.name : ing.productId;
          return `<li><span>${name}</span><span class="qty">${ing.quantity_g}g ${ing.state === 'cooked' ? '(cooked)' : ''}</span></li>`;
        }).join('')}
      </ul>
    </div>`;

  // Expandable prep
  if (meal.prep) {
    html += `<div class="expandable-trigger" data-expand="${key}-prep">Prep notes</div>
      <div class="expandable-content" id="expand-${key}-prep">
        <p style="font-size:0.75rem;color:var(--text-secondary);line-height:1.5">${meal.prep}</p>
      </div>`;
  }

  // Actions
  if (showActions) {
    if (isDone) {
      html += `<div style="display:flex;align-items:center;justify-content:space-between;margin-top:8px">
        <span style="font-size:0.75rem;color:var(--protein);font-weight:600">&#10003; Done</span>
        <div class="rating-group">
          <button class="rating-btn ${t.rating === 'up' ? 'selected' : ''}" data-rate="${key}" data-val="up">&#128077;</button>
          <button class="rating-btn ${t.rating === 'down' ? 'selected' : ''}" data-rate="${key}" data-val="down">&#128078;</button>
        </div>
      </div>`;
    } else if (isSkipped) {
      html += `<div style="margin-top:8px;font-size:0.75rem;color:var(--text-muted)">
        Skipped${t.skipReason ? ': ' + t.skipReason : ''}
      </div>`;
    } else {
      html += `<div class="btn-group">
        <button class="btn btn-primary" style="flex:1" data-done="${key}">Done</button>
        <button class="btn btn-secondary btn-small" data-skip="${key}">Skip</button>
      </div>`;
    }
  }

  html += '</div>';
  return html;
}

function formatSlot(slot) {
  const map = { breakfast: 'Bfast', lunch: 'Lunch', 'pre-workout': 'Pre-WO', 'post-workout': 'Post-WO', 'pre-bed': 'Bed' };
  return map[slot] || slot;
}

function attachMealCardEvents(day) {
  // Expandable triggers
  $content.querySelectorAll('.expandable-trigger').forEach(el => {
    el.addEventListener('click', () => {
      const targetId = 'expand-' + el.dataset.expand;
      const target = document.getElementById(targetId);
      if (target) {
        el.classList.toggle('open');
        target.classList.toggle('open');
      }
    });
  });

  // Done buttons
  $content.querySelectorAll('[data-done]').forEach(el => {
    el.addEventListener('click', () => {
      const key = el.dataset.done;
      state.tracking[key] = { ...(state.tracking[key] || {}), completed: true, timestamp: Date.now() };
      onTrackingChange();
      renderTab();
    });
  });

  // Skip buttons
  $content.querySelectorAll('[data-skip]').forEach(el => {
    el.addEventListener('click', () => {
      const key = el.dataset.skip;
      const reason = prompt('Skip reason (optional):') || '';
      state.tracking[key] = { ...(state.tracking[key] || {}), skipped: true, skipReason: reason, timestamp: Date.now() };
      onTrackingChange();
      renderTab();
    });
  });

  // Rating buttons
  $content.querySelectorAll('[data-rate]').forEach(el => {
    el.addEventListener('click', () => {
      const key = el.dataset.rate;
      const val = el.dataset.val;
      const current = state.tracking[key];
      if (current) {
        current.rating = current.rating === val ? null : val;
        onTrackingChange();
        renderTab();
      }
    });
  });
}

// ============================================
// PLAN TAB
// ============================================
function renderPlan() {
  $header.textContent = 'Plan';
  $headerInfo.textContent = `${plan.startDate} to ${plan.endDate}`;

  const todayIdx = getCurrentDayIndex();
  let selDay = state.selectedDay;
  const day = getDayByNum(selDay);

  // Day selector
  let html = '<div class="day-selector">';
  for (const d of plan.days) {
    const isActive = d.day === selDay;
    const isToday = d.day === todayIdx;
    const isPrepOnly = d.meals.length === 0;
    const isDayComplete = d.meals.length > 0 && d.meals.every(m => {
      const t = state.tracking[`${d.day}-${m.slot}`];
      return t && (t.completed || t.skipped);
    });
    let cls = 'day-chip';
    if (isActive) cls += ' active';
    if (isToday) cls += ' today';
    if (isPrepOnly) cls += ' prep';
    if (isDayComplete) cls += ' completed-day';

    html += `<button class="${cls}" data-select-day="${d.day}">
      <span class="day-label">${d.dayOfWeek.slice(0, 3)}</span>
      <span class="day-num">${isPrepOnly ? 'Prep' : d.day}</span>
    </button>`;
  }
  html += '</div>';

  if (!day) {
    html += '<div class="empty-state"><p>Select a day</p></div>';
    $content.innerHTML = html;
    attachDaySelector();
    return;
  }

  if (day.meals.length === 0) {
    html += `<div class="prep-banner">
      <h3>Prep Day ${day.day === 0 ? '(Pre-Plan)' : ''}</h3>
      <p>${day.batchPrepInstructions || 'No prep instructions.'}</p>
    </div>`;
    $content.innerHTML = html;
    attachDaySelector();
    return;
  }

  // Day macro totals vs targets
  const dayTotals = computeDayTotals(day, catalog);
  const targets = plan.dailyTargets;

  html += `<div class="card">
    <div class="stat-card-title">Day ${day.day} - ${day.dayOfWeek}, ${formatDate(day.date)}</div>
    <div class="day-bars">
      ${dayBarRow('Cal', dayTotals.calories, targets.calories)}
      ${dayBarRow('Pro', dayTotals.protein_g, targets.protein_g)}
      ${dayBarRow('Carb', dayTotals.carbs_g, targets.carbs_g)}
      ${dayBarRow('Fat', dayTotals.fat_g, targets.fat_g)}
    </div>
  </div>`;

  // Meals
  for (const meal of day.meals) {
    html += renderMealCard(day, meal, false);
  }

  $content.innerHTML = html;
  attachDaySelector();
  attachMealCardEvents(day);
}

function dayBarRow(label, actual, target) {
  const p = Math.min((actual / target) * 100, 150);
  const targetPos = Math.min((target / (target * 1.5)) * 100, 100);
  const barColor = macroColor(pct(actual, target));
  return `<div class="day-bar-row">
    <span class="day-bar-label">${label}</span>
    <div class="day-bar-track">
      <div class="day-bar-fill" style="width:${Math.min(p / 1.5, 100)}%;background:${barColor}">${Math.round(actual)}</div>
      <div class="day-bar-target" style="left:${targetPos}%"></div>
    </div>
  </div>`;
}

function attachDaySelector() {
  $content.querySelectorAll('[data-select-day]').forEach(el => {
    el.addEventListener('click', () => {
      state.selectedDay = parseInt(el.dataset.selectDay);
      renderTab();
    });
  });
}

// ============================================
// SHOP TAB
// ============================================
function renderShop() {
  $header.textContent = 'Shopping';
  $headerInfo.textContent = '';

  const week = state.selectedWeek;
  const weekDays = week === 1 ? [1,2,3,4,5,6,7] : [8,9,10,11,12,13,14];

  let shopList;
  try {
    shopList = computeShoppingList(plan, catalog, {}, weekDays);
  } catch (err) {
    $content.innerHTML = `<div class="empty-state"><p>Error computing shopping list: ${err.message}</p></div>`;
    return;
  }

  const checksKey = `shop_${week}`;
  const checks = state.shoppingChecks[checksKey] || {};

  // Running total
  let totalZAR = 0;
  let checkedZAR = 0;
  for (const item of shopList) {
    totalZAR += item.priceZAR;
    if (checks[item.productId]) checkedZAR += item.priceZAR;
  }

  let html = '';

  // Week toggle
  html += `<div class="week-toggle">
    <button class="week-toggle-btn ${week === 1 ? 'active' : ''}" data-week="1">Week 1</button>
    <button class="week-toggle-btn ${week === 2 ? 'active' : ''}" data-week="2">Week 2</button>
  </div>`;

  // Total bar
  html += `<div class="total-bar">
    <span class="total-label">${Object.keys(checks).filter(k => checks[k]).length} / ${shopList.length} items</span>
    <span class="total-amount">R${totalZAR.toFixed(2)}</span>
  </div>`;

  // Group by category
  const grouped = {};
  for (const item of shopList) {
    const cat = item.category || 'other';
    if (!grouped[cat]) grouped[cat] = [];
    grouped[cat].push(item);
  }

  // Unchecked first, checked at bottom
  const categories = Object.keys(grouped).sort();
  for (const cat of categories) {
    const items = grouped[cat];
    // Sort: unchecked first
    items.sort((a, b) => {
      const aChecked = checks[a.productId] ? 1 : 0;
      const bChecked = checks[b.productId] ? 1 : 0;
      return aChecked - bChecked;
    });

    html += `<div class="category-header">${cat}</div>`;
    for (const item of items) {
      const isChecked = checks[item.productId];
      const prod = getProduct(item.productId, catalog);
      const packLabel = item.packs > 1
        ? `${item.packs} x ${prod ? prod.packSize_g : '?'}g`
        : `${prod ? prod.packSize_g : '?'}g`;

      html += `<div class="shop-item ${isChecked ? 'checked' : ''}">
        <div class="shop-checkbox ${isChecked ? 'checked' : ''}" data-shop-check="${item.productId}"></div>
        <div class="shop-details">
          <div class="shop-name">${item.name}</div>
          <div class="shop-qty">${packLabel} (need ${item.totalNeeded_g}g)</div>
        </div>
        <div class="shop-price">R${item.priceZAR.toFixed(2)}</div>
      </div>`;
    }
  }

  if (shopList.length === 0) {
    html += '<div class="empty-state"><p>No items needed for this week.</p></div>';
  }

  $content.innerHTML = html;

  // Week toggle events
  $content.querySelectorAll('[data-week]').forEach(el => {
    el.addEventListener('click', () => {
      state.selectedWeek = parseInt(el.dataset.week);
      renderTab();
    });
  });

  // Checkbox events
  $content.querySelectorAll('[data-shop-check]').forEach(el => {
    el.addEventListener('click', () => {
      const pid = el.dataset.shopCheck;
      const checksKey = `shop_${state.selectedWeek}`;
      if (!state.shoppingChecks[checksKey]) state.shoppingChecks[checksKey] = {};
      state.shoppingChecks[checksKey][pid] = !state.shoppingChecks[checksKey][pid];
      onShoppingChange();
      renderTab();
    });
  });
}

// ============================================
// STOCK TAB
// ============================================
function renderStock() {
  $header.textContent = 'Inventory';
  $headerInfo.textContent = '';

  // Build tracking object in format computeInventory expects
  const trackingForEngine = {};
  for (const [key, val] of Object.entries(state.tracking)) {
    trackingForEngine[key] = { skipped: val.skipped || false };
  }

  // Get full shopping list (all days, no inventory subtracted) to know what was purchased
  let fullShop;
  try {
    fullShop = computeShoppingList(plan, catalog, {});
  } catch (err) {
    $content.innerHTML = `<div class="empty-state"><p>Error: ${err.message}</p></div>`;
    return;
  }

  let stock;
  try {
    stock = computeInventory(fullShop, plan, catalog, trackingForEngine, state.inventoryAdj);
  } catch (err) {
    $content.innerHTML = `<div class="empty-state"><p>Error computing inventory: ${err.message}</p></div>`;
    return;
  }

  // Build display list
  const items = [];
  for (const [pid, remaining] of Object.entries(stock)) {
    const prod = getProduct(pid, catalog);
    if (!prod) continue;
    items.push({
      productId: pid,
      name: prod.name,
      remaining,
      packSize: prod.packSize_g,
      pctRemaining: Math.round((remaining / prod.packSize_g) * 100)
    });
  }

  // Sort: in-stock first, then by name
  items.sort((a, b) => {
    if (a.remaining === 0 && b.remaining > 0) return 1;
    if (a.remaining > 0 && b.remaining === 0) return -1;
    return a.name.localeCompare(b.name);
  });

  let html = `<div class="total-bar">
    <span class="total-label">${items.filter(i => i.remaining > 0).length} items in stock</span>
    <span style="font-size:0.75rem;color:var(--text-secondary)">${items.filter(i => i.remaining === 0).length} out</span>
  </div>`;

  for (const item of items) {
    const isLow = item.remaining > 0 && item.pctRemaining < 15;
    const isOut = item.remaining === 0;
    let cls = 'inv-item';
    if (isLow) cls += ' low';
    if (isOut) cls += ' out';

    html += `<div class="${cls}">
      <div class="inv-item-header">
        <span class="inv-name">${item.name}${isLow ? ' (low)' : ''}</span>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="inv-qty">${item.remaining}g</span>
          <button class="btn btn-secondary btn-small" data-adjust="${item.productId}" data-current="${item.remaining}">Adjust</button>
        </div>
      </div>
      <div class="progress-bar">
        <div class="fill" style="width:${Math.min(item.pctRemaining, 100)}%;background:${(isLow || isOut) ? var_calories : var_protein}"></div>
      </div>
    </div>`;
  }

  if (items.length === 0) {
    html += '<div class="empty-state"><p>No inventory data available.</p></div>';
  }

  $content.innerHTML = html;

  // Adjust events
  $content.querySelectorAll('[data-adjust]').forEach(el => {
    el.addEventListener('click', () => {
      showAdjustModal(el.dataset.adjust, parseInt(el.dataset.current));
    });
  });
}

function showAdjustModal(productId, currentVal) {
  const prod = getProduct(productId, catalog);
  const name = prod ? prod.name : productId;

  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = `<div class="modal-sheet">
    <div class="modal-title">Adjust: ${name}</div>
    <div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:12px">Current: ${currentVal}g</div>
    <div class="modal-input-group">
      <button class="modal-adj-btn" data-delta="-50">-50</button>
      <button class="modal-adj-btn" data-delta="-10">-10</button>
      <input type="number" class="modal-input" id="adj-input" value="${currentVal}" min="0" step="10">
      <button class="modal-adj-btn" data-delta="10">+10</button>
      <button class="modal-adj-btn" data-delta="50">+50</button>
    </div>
    <div class="modal-actions">
      <button class="btn btn-danger btn-small" id="adj-zero">Set to 0</button>
      <button class="btn btn-secondary" id="adj-cancel">Cancel</button>
      <button class="btn btn-primary" id="adj-save">Save</button>
    </div>
  </div>`;

  document.body.appendChild(overlay);

  const input = overlay.querySelector('#adj-input');

  overlay.querySelectorAll('[data-delta]').forEach(btn => {
    btn.addEventListener('click', () => {
      const delta = parseInt(btn.dataset.delta);
      input.value = Math.max(0, parseInt(input.value || 0) + delta);
    });
  });

  overlay.querySelector('#adj-zero').addEventListener('click', () => {
    input.value = 0;
  });

  overlay.querySelector('#adj-cancel').addEventListener('click', () => {
    overlay.remove();
  });

  overlay.querySelector('#adj-save').addEventListener('click', () => {
    const newVal = Math.max(0, parseInt(input.value || 0));
    // Calculate the delta from the current computed value
    // We need to figure out what adjustment makes the inventory show newVal
    // The engine computes: stock + adjustment = displayed
    // So adjustment = newVal - stockWithoutAdj
    // But we have currentVal which already includes old adjustments
    // Simplest: re-derive without adjustments, then set adjustment = newVal - derived
    const trackingForEngine = {};
    for (const [key, val] of Object.entries(state.tracking)) {
      trackingForEngine[key] = { skipped: val.skipped || false };
    }
    const fullShop = computeShoppingList(plan, catalog, {});
    const stockNoAdj = computeInventory(fullShop, plan, catalog, trackingForEngine, {});
    const derivedVal = stockNoAdj[productId] || 0;
    const adj = newVal - derivedVal;

    if (adj === 0) {
      delete state.inventoryAdj[productId];
    } else {
      state.inventoryAdj[productId] = adj;
    }
    onInventoryChange();
    overlay.remove();
    renderTab();
  });

  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) overlay.remove();
  });
}

// ============================================
// STATS TAB
// ============================================
function renderStats() {
  $header.textContent = 'Dashboard';
  $headerInfo.textContent = '';

  const todayIdx = getCurrentDayIndex();
  const targets = plan.dailyTargets;

  // Weekly averages
  const w1Days = [1,2,3,4,5,6,7];
  const w2Days = [8,9,10,11,12,13,14];
  const w1Avg = computeWeeklyAverages(plan, catalog, w1Days);
  const w2Avg = computeWeeklyAverages(plan, catalog, w2Days);
  const allAvg = computeWeeklyAverages(plan, catalog, [...w1Days, ...w2Days]);

  // Budget
  let totalCost = 0;
  try {
    const fullShop = computeShoppingList(plan, catalog, {});
    totalCost = fullShop.reduce((sum, item) => sum + item.priceZAR, 0);
  } catch { /* ignore */ }

  // Tracking stats
  let totalMeals = 0;
  let completedMeals = 0;
  let skippedMeals = 0;
  let thumbsUp = 0;
  let thumbsDown = 0;
  for (const d of plan.days) {
    for (const m of d.meals) {
      totalMeals++;
      const t = state.tracking[`${d.day}-${m.slot}`];
      if (t?.completed) completedMeals++;
      if (t?.skipped) skippedMeals++;
      if (t?.rating === 'up') thumbsUp++;
      if (t?.rating === 'down') thumbsDown++;
    }
  }

  const planProgress = Math.max(0, Math.min(todayIdx, 14));
  const completionRate = totalMeals > 0 ? Math.round((completedMeals / totalMeals) * 100) : 0;

  let html = '';

  // Plan progress
  html += `<div class="stat-card">
    <div class="stat-card-title">Plan Progress</div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <span style="font-size:0.85rem;font-weight:600">Day ${Math.min(todayIdx, 14)} of 14</span>
      <span style="font-size:0.75rem;color:var(--text-secondary)">${Math.round((planProgress / 14) * 100)}%</span>
    </div>
    <div class="progress-bar progress-bar-lg">
      <div class="fill" style="width:${(planProgress / 14) * 100}%;background:var(--accent)"></div>
    </div>
    <div class="stat-grid" style="margin-top:12px">
      <div><div class="stat-value">${completedMeals}</div><div class="stat-unit">meals done</div></div>
      <div><div class="stat-value">${skippedMeals}</div><div class="stat-unit">meals skipped</div></div>
      <div><div class="stat-value">${completionRate}%</div><div class="stat-unit">completion rate</div></div>
      <div><div class="stat-value">${thumbsUp}/${thumbsDown}</div><div class="stat-unit">thumbs up/down</div></div>
    </div>
  </div>`;

  // Average macros card
  html += `<div class="stat-card">
    <div class="stat-card-title">Average Daily Macros (Plan)</div>
    <div class="day-bars">
      ${dayBarRow('Cal', allAvg.avgCalories, targets.calories)}
      ${dayBarRow('Pro', allAvg.avgProtein_g, targets.protein_g)}
      ${dayBarRow('Carb', allAvg.avgCarbs_g, targets.carbs_g)}
      ${dayBarRow('Fat', allAvg.avgFat_g, targets.fat_g)}
    </div>
  </div>`;

  // Macro split donut
  const totalPCal = allAvg.avgProtein_g * 4;
  const totalCCal = allAvg.avgCarbs_g * 4;
  const totalFCal = allAvg.avgFat_g * 9;
  const totalMacroCal = totalPCal + totalCCal + totalFCal;
  const pPct = totalMacroCal > 0 ? Math.round((totalPCal / totalMacroCal) * 100) : 0;
  const cPct = totalMacroCal > 0 ? Math.round((totalCCal / totalMacroCal) * 100) : 0;
  const fPct = 100 - pPct - cPct;

  html += `<div class="stat-card">
    <div class="stat-card-title">Macro Split</div>
    <div class="donut-container">
      <div class="donut" style="background:conic-gradient(${var_protein} 0% ${pPct}%, ${var_carbs} ${pPct}% ${pPct + cPct}%, ${var_fat} ${pPct + cPct}% 100%)">
        <div class="donut-center">
          <span class="value">${allAvg.avgCalories}</span>
          <span class="label">kcal/day</span>
        </div>
      </div>
      <div class="donut-legend">
        <div class="donut-legend-item"><span class="donut-legend-dot" style="background:${var_protein}"></span> Protein ${pPct}% (${allAvg.avgProtein_g}g)</div>
        <div class="donut-legend-item"><span class="donut-legend-dot" style="background:${var_carbs}"></span> Carbs ${cPct}% (${allAvg.avgCarbs_g}g)</div>
        <div class="donut-legend-item"><span class="donut-legend-dot" style="background:${var_fat}"></span> Fat ${fPct}% (${allAvg.avgFat_g}g)</div>
      </div>
    </div>
  </div>`;

  // Week comparison
  html += `<div class="stat-card">
    <div class="stat-card-title">Week 1 vs Week 2</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:0.78rem">
      <div style="text-align:center">
        <div style="font-weight:700;margin-bottom:4px">Week 1</div>
        <div>${w1Avg.avgCalories} kcal</div>
        <div style="color:${var_protein}">${w1Avg.avgProtein_g}g P</div>
        <div style="color:${var_carbs}">${w1Avg.avgCarbs_g}g C</div>
        <div style="color:${var_fat}">${w1Avg.avgFat_g}g F</div>
      </div>
      <div style="text-align:center">
        <div style="font-weight:700;margin-bottom:4px">Week 2</div>
        <div>${w2Avg.avgCalories} kcal</div>
        <div style="color:${var_protein}">${w2Avg.avgProtein_g}g P</div>
        <div style="color:${var_carbs}">${w2Avg.avgCarbs_g}g C</div>
        <div style="color:${var_fat}">${w2Avg.avgFat_g}g F</div>
      </div>
    </div>
  </div>`;

  // Budget
  html += `<div class="stat-card">
    <div class="stat-card-title">Budget</div>
    <div class="stat-grid">
      <div><div class="stat-value">R${totalCost.toFixed(0)}</div><div class="stat-unit">estimated total</div></div>
      <div><div class="stat-value">R${(totalCost / 14).toFixed(0)}</div><div class="stat-unit">per day</div></div>
    </div>
  </div>`;

  // Per-day adherence chart
  html += `<div class="stat-card">
    <div class="stat-card-title">Daily Calorie Adherence</div>`;
  for (const d of plan.days) {
    if (d.meals.length === 0) continue;
    const dt = computeDayTotals(d, catalog);
    const p = pct(dt.calories, targets.calories);
    const color = macroColor(p);
    html += `<div class="adherence-row">
      <span class="adherence-day">${d.day}</span>
      <div class="adherence-bar"><div class="adherence-fill" style="width:${Math.min(p, 100)}%;background:${color}"></div></div>
    </div>`;
  }
  html += '</div>';

  $content.innerHTML = html;
}

// ============================================
// Auth & Sync
// ============================================
let currentUser = null;
let syncQueue = [];
let syncInProgress = false;
const SYNC_QUEUE_KEY = 'sync_queue';

// Load any queued sync operations from localStorage
function loadSyncQueue() {
  try { syncQueue = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY)) || []; } catch { syncQueue = []; }
}

function saveSyncQueue() {
  localStorage.setItem(SYNC_QUEUE_KEY, JSON.stringify(syncQueue));
}

function queueSync(op) {
  syncQueue.push(op);
  saveSyncQueue();
  processSyncQueue();
}

async function processSyncQueue() {
  if (!currentUser || !navigator.onLine || syncQueue.length === 0 || syncInProgress) return;
  syncInProgress = true;

  showSyncIndicator('Syncing...');
  const queue = [...syncQueue];
  syncQueue = [];
  saveSyncQueue();

  for (const op of queue) {
    try {
      switch (op.type) {
        case 'tracking':
          await withTimeout(syncTracking(op.planId, op.data));
          break;
        case 'inventory':
          await withTimeout(syncInventory(op.data));
          break;
        case 'shopping':
          await withTimeout(syncShoppingChecks(op.planId, op.week, op.data));
          break;
      }
    } catch (err) {
      console.warn('Sync failed, re-queuing:', err);
      syncQueue.push(op);
    }
  }

  saveSyncQueue();
  syncInProgress = false;
  if (syncQueue.length > 0) {
    showSyncIndicator('Sync failed');
    setTimeout(hideSyncIndicator, 4000);
  } else {
    hideSyncIndicator();
  }
}

function showSyncIndicator(text) {
  const badge = document.getElementById('sync-badge');
  badge.textContent = text;
  badge.classList.add('visible');
}

function hideSyncIndicator() {
  const badge = document.getElementById('sync-badge');
  badge.classList.remove('visible');
}

// Called after any tracking change
function onTrackingChange() {
  saveLS(`tracking_${plan.planId}`, state.tracking);
  queueSync({ type: 'tracking', planId: plan.planId, data: state.tracking });
}

// Called after any shopping change
function onShoppingChange() {
  saveLS(`shopping_${plan.planId}`, state.shoppingChecks);
  const week = state.selectedWeek;
  const checksKey = `shop_${week}`;
  const data = state.shoppingChecks[checksKey] || {};
  queueSync({ type: 'shopping', planId: plan.planId, week, data });
}

// Called after any inventory adjustment change
function onInventoryChange() {
  saveLS(`inventory_adj_${plan.planId}`, state.inventoryAdj);
  queueSync({ type: 'inventory', data: state.inventoryAdj });
}

// Offline detection
function updateOnlineStatus() {
  const badge = document.getElementById('offline-badge');
  if (navigator.onLine) {
    badge.classList.remove('visible');
    processSyncQueue();
  } else {
    badge.classList.add('visible');
  }
}

window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

// Settings panel toggle
const $settingsBtn = document.getElementById('settings-btn');
const $settingsPanel = document.getElementById('settings-panel');

$settingsBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  $settingsPanel.classList.toggle('open');
});

document.addEventListener('click', (e) => {
  if (!$settingsPanel.contains(e.target) && e.target !== $settingsBtn) {
    $settingsPanel.classList.remove('open');
  }
});

// Auth UI
const $authSignedOut = document.getElementById('auth-signed-out');
const $authSignedIn = document.getElementById('auth-signed-in');
const $authEmail = document.getElementById('auth-email');
const $authSignInBtn = document.getElementById('auth-signin-btn');
const $authSignOutBtn = document.getElementById('auth-signout-btn');
const $authUserEmail = document.getElementById('auth-user-email');
const $authMsg = document.getElementById('auth-msg');

function updateAuthUI() {
  if (currentUser) {
    $authSignedOut.style.display = 'none';
    $authSignedIn.style.display = 'block';
    $authUserEmail.textContent = currentUser.email;
  } else {
    $authSignedOut.style.display = 'block';
    $authSignedIn.style.display = 'none';
    $authUserEmail.textContent = '';
  }
  $authMsg.textContent = '';
  $authMsg.className = 'auth-msg';
}

$authSignInBtn.addEventListener('click', async () => {
  const email = $authEmail.value.trim();
  if (!email) {
    $authMsg.textContent = 'Please enter your email address.';
    $authMsg.className = 'auth-msg error';
    return;
  }
  $authSignInBtn.disabled = true;
  $authSignInBtn.textContent = 'Sending...';
  try {
    const { error } = await signIn(email);
    if (error) throw error;
    $authMsg.textContent = 'Magic link sent! Check your email.';
    $authMsg.className = 'auth-msg success';
  } catch (err) {
    $authMsg.textContent = 'Sign in failed: ' + (err.message || err);
    $authMsg.className = 'auth-msg error';
  } finally {
    $authSignInBtn.disabled = false;
    $authSignInBtn.textContent = 'Sign in';
  }
});

$authSignOutBtn.addEventListener('click', async () => {
  $authSignOutBtn.disabled = true;
  $authSignOutBtn.textContent = 'Signing out...';
  try {
    await withTimeout(signOut(), 5000);
  } catch { /* ignore — force-clear below handles it regardless */ }
  // Force-clear local Supabase session regardless of API result
  for (const key of [...Object.keys(localStorage)]) {
    if (key.startsWith('sb-') || key === 'supabase.auth.token') localStorage.removeItem(key);
  }
  supabaseClient = null; // Force re-init on next use
  currentUser = null;
  $authSignOutBtn.disabled = false;
  $authSignOutBtn.textContent = 'Sign out';
  updateAuthUI();
});

const $authSyncNowBtn = document.getElementById('auth-sync-now-btn');
$authSyncNowBtn.addEventListener('click', async () => {
  const $syncStatus = document.getElementById('auth-sync-status');
  $authSyncNowBtn.disabled = true;
  $authSyncNowBtn.textContent = 'Syncing...';
  $syncStatus.textContent = '';
  try {
    const user = await getUser();
    if (!user) {
      $syncStatus.textContent = 'Session expired — please sign out and sign in again.';
      $syncStatus.className = 'auth-msg error';
      currentUser = null;
      updateAuthUI();
      return;
    }
    currentUser = user;
    await mergeRemoteData();
    await processSyncQueue();
    $syncStatus.textContent = syncQueue.length > 0 ? 'Sync failed — check connection.' : 'Synced.';
    $syncStatus.className = 'auth-msg success';
    setTimeout(() => { $syncStatus.textContent = ''; $syncStatus.className = 'auth-msg'; }, 3000);
  } catch (err) {
    $syncStatus.textContent = 'Sync error: ' + (err.message || 'Check connection or Supabase project status.');
    $syncStatus.className = 'auth-msg error';
  } finally {
    $authSyncNowBtn.disabled = false;
    $authSyncNowBtn.textContent = 'Sync now';
  }
});

// Migrate localStorage to Supabase on first authenticated load
async function migrateLocalStorageToSupabase() {
  const migratedKey = `supabase_migrated_${plan.planId}`;
  if (localStorage.getItem(migratedKey)) return;

  showSyncIndicator('Migrating data...');
  try {
    // Sync tracking
    const tracking = loadLS(`tracking_${plan.planId}`);
    if (tracking && Object.keys(tracking).length > 0) {
      await syncTracking(plan.planId, tracking);
    }

    // Sync shopping checks
    const shopping = loadLS(`shopping_${plan.planId}`);
    if (shopping) {
      for (const [checksKey, data] of Object.entries(shopping)) {
        const weekMatch = checksKey.match(/^shop_(\d+)$/);
        if (weekMatch && data) {
          await syncShoppingChecks(plan.planId, parseInt(weekMatch[1]), data);
        }
      }
    }

    // Sync inventory adjustments
    const invAdj = loadLS(`inventory_adj_${plan.planId}`);
    if (invAdj && Object.keys(invAdj).length > 0) {
      await syncInventory(invAdj);
    }

    localStorage.setItem(migratedKey, 'true');
  } catch (err) {
    console.warn('Migration failed:', err);
  } finally {
    hideSyncIndicator();
  }
}

// On app load: merge Supabase data if newer
async function mergeRemoteData() {
  showSyncIndicator('Loading...');
  try {
    // Load remote tracking
    const remoteTracking = await loadTracking(plan.planId);
    if (remoteTracking && remoteTracking.meals) {
      for (const [key, remoteEntry] of Object.entries(remoteTracking.meals)) {
        const localEntry = state.tracking[key];
        const remoteTs = remoteEntry.timestamp || 0;
        const localTs = localEntry?.timestamp || 0;
        if (remoteTs > localTs) {
          state.tracking[key] = remoteEntry;
        }
      }
      saveLS(`tracking_${plan.planId}`, state.tracking);
    }

    // Load remote shopping checks for both weeks
    for (const week of [1, 2]) {
      const remoteChecks = await loadShoppingChecks(plan.planId, week);
      if (remoteChecks) {
        const checksKey = `shop_${week}`;
        state.shoppingChecks[checksKey] = { ...(state.shoppingChecks[checksKey] || {}), ...remoteChecks };
      }
    }
    saveLS(`shopping_${plan.planId}`, state.shoppingChecks);

    // Load remote inventory
    const remoteInv = await loadInventory();
    if (remoteInv) {
      for (const [pid, val] of Object.entries(remoteInv)) {
        if (!(pid in state.inventoryAdj)) {
          state.inventoryAdj[pid] = val;
        }
      }
      saveLS(`inventory_adj_${plan.planId}`, state.inventoryAdj);
    }

    renderTab();
  } catch (err) {
    console.warn('Failed to merge remote data:', err);
  } finally {
    hideSyncIndicator();
  }
}

// Initialize auth state
async function initAuth() {
  if (!isSupabaseConfigured()) return;

  try {
    const client = await initSupabase();

    // onAuthStateChange fires INITIAL_SESSION immediately for existing sessions,
    // and SIGNED_IN / TOKEN_REFRESHED for new logins and token refreshes.
    // We handle all cases here — no separate getUser() call needed.
    client.auth.onAuthStateChange(async (event, session) => {
      currentUser = session?.user || null;
      updateAuthUI();
      if (event === 'INITIAL_SESSION' && currentUser) {
        // Existing session on app load — pull remote data
        await mergeRemoteData();
        processSyncQueue();
      } else if (currentUser && (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED')) {
        // New login (magic link) or token refresh
        await migrateLocalStorageToSupabase();
        await mergeRemoteData();
        processSyncQueue();
      }
    });
  } catch (err) {
    console.warn('Auth init failed:', err);
  }
}

// ============================================
// Diagnostics (call window.diagSupabase() from DevTools)
// ============================================
window.diagSupabase = async function() {
  console.group('[Supabase Diag]');
  console.log('Configured:', isSupabaseConfigured());
  console.log('Online:', navigator.onLine);
  console.log('Current user:', currentUser?.email ?? 'none');
  console.log('Sync queue:', syncQueue.length, 'ops', syncQueue);
  console.log('Sync in progress:', syncInProgress);
  if (!isSupabaseConfigured()) { console.groupEnd(); return; }
  try {
    const client = await initSupabase();
    console.log('Client: OK');
    const t1 = Date.now();
    const { data: { user }, error: authErr } = await withTimeout(client.auth.getUser(), 5000);
    console.log(`getUser() ${Date.now() - t1}ms — user: ${user?.email ?? 'none'}`, authErr ? `err: ${authErr.message}` : '');
    if (user) {
      const t2 = Date.now();
      const { error: dbErr } = await withTimeout(
        client.from('tracking').select('count').eq('user_id', user.id).limit(1),
        5000
      );
      console.log(`DB ping ${Date.now() - t2}ms —`, dbErr ? `FAILED: ${dbErr.message}` : 'OK');
    }
  } catch (err) {
    console.error('Diag failed:', err.message);
  }
  console.groupEnd();
};

// ============================================
// Init
// ============================================
document.getElementById('loading').style.display = 'none';
document.getElementById('app').style.display = 'flex';
updateOnlineStatus();
loadSyncQueue();
switchTab('today');
initAuth();


})();
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}
</script>
</body>
</html>
